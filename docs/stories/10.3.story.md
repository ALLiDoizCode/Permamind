# Story 10.3: ArNS Cost Calculation & Pricing

## Status

Done

## Story

**As a** user planning ArNS name registration,  
**I want** to calculate costs for different registration types so that **I can make informed decisions about lease durations and permanent ownership**.

## Acceptance Criteria

1. **Implement GetArnsTokenCostCommand**
   - Create comprehensive price calculation tool for ArNS registrations
   - Support cost calculation for lease registrations (1-5 year duration options)
   - Support cost calculation for permanent registration options
   - Include demand-based pricing calculation using ar-io-sdk pricing APIs

2. **Cost Breakdown and Comparison**
   - Provide cost breakdown and comparison between lease vs permanent options
   - Support undername count pricing for increased undername limits
   - Include registration fee structures and calculations
   - Display pricing information in user-friendly format

3. **Error Handling and Reliability**
   - Handle pricing failures gracefully with fallback estimates when possible
   - Implement comprehensive error handling for network issues and API failures
   - Provide clear error messages and guidance for pricing retrieval failures
   - Support timeout handling and retry mechanisms

## Tasks / Subtasks

- [ ] **Task 1: Create GetArnsTokenCostCommand Structure** (AC: 1)
  - [ ] Create `src/tools/arns/commands/GetArnsTokenCostCommand.ts` following existing tool patterns
  - [ ] Implement ToolCommand base class extension with proper typing
  - [ ] Add comprehensive Zod parameter validation schema for pricing requests
  - [ ] Include proper tool metadata and descriptions for AI usage

- [ ] **Task 2: Implement Core Pricing Logic** (AC: 1, 2)
  - [ ] Integrate ar-io-sdk pricing APIs (`getTokenCost()` methods)
  - [ ] Implement duration-based calculation logic for lease options (1-5 years)
  - [ ] Add permanent registration cost calculation
  - [ ] Create cost comparison utilities for decision support

- [ ] **Task 3: Add Cost Breakdown Features** (AC: 2)
  - [ ] Implement detailed cost breakdown (base cost, duration multiplier, demand factors)
  - [ ] Add lease vs permanent cost comparison calculations
  - [ ] Support undername count pricing calculations
  - [ ] Create user-friendly cost presentation format

- [ ] **Task 4: Implement Error Handling and Fallbacks** (AC: 3)
  - [ ] Add comprehensive error handling for ar-io-sdk API failures
  - [ ] Implement fallback pricing estimates when live pricing unavailable
  - [ ] Add network timeout and retry mechanisms
  - [ ] Provide clear error messages with actionable guidance

- [ ] **Task 5: Register Command in ArnsToolFactory** (AC: 1)
  - [ ] Add GetArnsTokenCostCommand to ArnsToolFactory.getToolClasses()
  - [ ] Ensure proper command registration following existing patterns
  - [ ] Verify tool appears in MCP tool registry
  - [ ] Test command discovery and execution flow

- [ ] **Task 6: Create Unit Tests** (AC: 1, 2, 3)
  - [ ] Create `tests/unit/tools/arns/commands/GetArnsTokenCostCommand.unit.test.ts`
  - [ ] Mock ar-io-sdk pricing API calls using Vitest vi.mock()
  - [ ] Test all pricing calculation scenarios (lease, permanent, undername)
  - [ ] Test error handling and fallback mechanisms

## Dev Notes

### Previous Story Context

From Story 10.1 completion notes:

- ArNS infrastructure established with `ArnsClientManager` singleton for network management
- ArNS directory structure created following project patterns: `src/tools/arns/`
- `ArnsToolFactory` ready for command registration with proper BaseToolFactory extension
- ar-io-sdk integration completed with network switching support (mainnet/testnet)
- Environment variable `ARNS_NETWORK` configured for network selection

### Technology Stack Integration

**Core Technologies** [Source: docs/architecture/tech-stack.md]:

- TypeScript 5.8+ with strict typing requirements
- FastMCP 1.27+ framework patterns for MCP tool implementation
- Node.js 20+ runtime environment
- Existing ar-io-sdk integration from Story 10.1

**ArNS-Specific Integration** [Source: ar-io-sdk documentation]:

- ar-io-sdk pricing APIs for cost calculation
- Network support: Mainnet, Testnet configurations via ArnsClientManager
- IO token economics integration for payment calculations
- Demand-based pricing with real-time API calls

### Project Structure Alignment

**Tool Organization** [Source: docs/architecture/source-tree.md]:

```
src/tools/arns/                    # Existing ArNS tool category
├── ArnsToolFactory.ts             # Factory class (will be updated)
├── utils/
│   └── ArnsClientManager.ts       # Client management singleton (available)
├── commands/                      # Commands directory (ready for new command)
│   ├── GetArnsTokenCostCommand.ts # New file to create
│   └── index.ts                   # Will be updated with new export
└── index.ts                       # Main exports
```

**Factory Pattern Requirements** [Source: Story 10.1]:

- Extend BaseToolFactory class from `../core/index.js`
- Add GetArnsTokenCostCommand to getToolClasses() method array
- Follow naming conventions: PascalCase with Command suffix
- Use ToolContext interface for dependency injection

### Command Implementation Architecture

**ToolCommand Base Class Pattern** [Source: existing token tools]:

```typescript
export class GetArnsTokenCostCommand extends ToolCommand<GetArnsTokenCostArgs, string> {
  protected metadata: ToolMetadata = {
    description: "Calculate costs for ArNS name registration including lease and permanent options with demand-based pricing",
    name: "getArnsTokenCost",
    openWorldHint: false,
    readOnlyHint: true,
    title: "Get ArNS Token Cost",
  };

  protected parametersSchema = z.object({
    name: z.string().describe("ArNS name to calculate cost for (without .ar suffix)"),
    type: z.enum(["lease", "permanent"]).describe("Registration type"),
    years: z.number().min(1).max(5).optional().describe("Lease duration (1-5 years, required for lease type)"),
    undernames: z.number().min(10).max(100).optional().describe("Number of undernames to support (default: 10)"),
    confirmed: z.boolean().optional().describe("Set to true to confirm cost calculation"),
  });
```

**Integration with ArnsClientManager** [Source: Story 10.1 implementation]:

```typescript
import { ArnsClientManager } from "../utils/ArnsClientManager.js";

// In execute method:
const clientManager = ArnsClientManager.getInstance();
await clientManager.initializeClient(); // Uses ARNS_NETWORK env var
const arnsClient = clientManager.getClient();
if (!arnsClient) {
  throw new Error("ArNS client not initialized");
}

// Use arnsClient for pricing API calls
```

### ArNS Pricing API Integration

**ar-io-sdk Pricing Methods** [Source: ar-io-sdk documentation]:

```typescript
// Get cost for registration
const cost = await arnsClient.getTokenCost({
  name: "example", // name without .ar suffix
  years: 1, // for lease registration
  type: "lease" | "permanent",
});

// Cost result structure:
interface TokenCost {
  tokenCost: string; // Cost in IO tokens (string format for precision)
  networkFee: string; // Network fee component
  totalCost: string; // Total cost including all fees
}
```

**Duration and Type Calculations**:

- **Lease Types**: 1-5 year duration options with different pricing tiers
- **Permanent Type**: One-time payment for permanent ownership
- **Undername Limits**: Additional cost for expanding from 10 to up to 100 undernames
- **Demand-based Pricing**: Real-time pricing based on name popularity and network demand

### Error Handling Requirements

**Error Handling Standards** [Source: docs/architecture/coding-standards.md]:

- Comprehensive try-catch blocks with meaningful error messages
- Proper error propagation and logging
- Graceful failure management

**ArNS-Specific Error Scenarios**:

- Network connectivity issues (use fallback estimates)
- Invalid name format (validation errors)
- API timeout or rate limiting (retry mechanisms)
- SDK errors (wrap with user-friendly messages)

**Fallback Strategy Implementation**:

```typescript
try {
  const livePricing = await arnsClient.getTokenCost(params);
  return livePricing;
} catch (error) {
  console.warn(
    `Live pricing failed: ${error.message}, using fallback estimates`,
  );

  // Fallback to estimated pricing based on known patterns
  return {
    tokenCost: estimateBaseCost(params),
    networkFee: estimateNetworkFee(),
    totalCost: estimateBaseCost(params) + estimateNetworkFee(),
    isEstimate: true,
    error: error.message,
  };
}
```

### Parameter Validation and Types

**Zod Schema Validation Patterns** [Source: existing tool patterns]:

```typescript
const parametersSchema = z.object({
  name: z
    .string()
    .min(1)
    .max(51) // ArNS name length limits
    .regex(/^[a-zA-Z0-9-]+$/) // Valid ArNS characters
    .describe("ArNS name to calculate cost for (without .ar suffix)"),

  type: z
    .enum(["lease", "permanent"])
    .describe(
      "Registration type - lease for 1-5 years, permanent for lifetime ownership",
    ),

  years: z
    .number()
    .int()
    .min(1)
    .max(5)
    .optional()
    .describe("Lease duration in years (1-5, required for lease type)"),

  undernames: z
    .number()
    .int()
    .min(10)
    .max(100)
    .optional()
    .default(10)
    .describe("Number of undernames to support (10-100, default: 10)"),

  network: z
    .enum(["mainnet", "testnet"])
    .optional()
    .describe("Network to use for pricing (defaults to ARNS_NETWORK env var)"),
});
```

**Validation Logic**:

- Conditional validation: years required when type is "lease"
- Name format validation for ArNS compliance
- Network parameter validation with environment variable fallback
- Undername limit validation (10-100 range)

### Response Format Specification

**Structured Response Format** [Source: existing tool patterns]:

```typescript
interface ArnsTokenCostResponse {
  success: boolean;
  name: string;
  type: "lease" | "permanent";
  years?: number;
  undernames: number;
  network: string;
  pricing: {
    baseCost: string; // IO tokens
    networkFee: string;
    undernameFee?: string;
    totalCost: string;
    isEstimate: boolean;
  };
  comparison?: {
    leaseTotal?: string;
    permanentCost?: string;
    recommendation?: string;
  };
  error?: {
    code: string;
    message: string;
    suggestions: string[];
  };
}
```

### Testing Requirements

**Unit Testing Standards** [Source: existing test patterns]:

Test file: `tests/unit/tools/arns/commands/GetArnsTokenCostCommand.unit.test.ts`

```typescript
// Mock ar-io-sdk dependencies
vi.mock("@ar.io/sdk/node", () => ({
  ARIO: {
    mainnet: vi.fn(),
    testnet: vi.fn(),
  },
}));

// Mock ArnsClientManager
vi.mock("../../../src/tools/arns/utils/ArnsClientManager.js", () => ({
  ArnsClientManager: {
    getInstance: vi.fn(),
  },
}));

describe("GetArnsTokenCostCommand", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe("Parameter Validation", () => {
    it("should validate lease type requires years parameter", async () => {
      // Test conditional validation logic
    });

    it("should validate name format and length", async () => {
      // Test ArNS name validation
    });

    it("should validate undername limits", async () => {
      // Test 10-100 range validation
    });
  });

  describe("Pricing Calculations", () => {
    it("should calculate lease pricing for different durations", async () => {
      // Test 1-5 year lease calculations
    });

    it("should calculate permanent registration cost", async () => {
      // Test permanent pricing
    });

    it("should include undername pricing", async () => {
      // Test undername cost additions
    });
  });

  describe("Error Handling", () => {
    it("should handle API failures with fallback estimates", async () => {
      // Test fallback pricing mechanism
    });

    it("should handle network timeout scenarios", async () => {
      // Test timeout and retry logic
    });
  });
});
```

**Key Test Scenarios**:

- Parameter validation for all input combinations
- Cost calculation accuracy for different registration types
- Error handling and fallback estimate generation
- Network switching and client management integration
- Response format consistency and structure

### Integration with Existing Infrastructure

**ToolContext Usage** [Source: existing tool patterns]:

- GetArnsTokenCostCommand receives ToolContext containing keyPair, publicKey, hubId
- ArnsClientManager integration for network-aware pricing
- AutoSafeToolContext patterns for initialization

**Performance Considerations**:

- Cache pricing information for repeated requests (5-minute TTL)
- Batch pricing requests when calculating multiple scenarios
- Network timeout configuration (30-second default)
- Graceful degradation to offline estimates when needed

### Dependencies and Integration

**Existing Dependencies** (from Story 10.1):

- ar-io-sdk: Already installed and configured
- ArnsClientManager: Available for client management
- ArnsToolFactory: Ready for command registration

**Import Patterns**:

```typescript
import { z } from "zod";
import { ARIO } from "@ar.io/sdk/node";
import {
  AutoSafeToolContext,
  ToolCommand,
  ToolContext,
  ToolMetadata,
} from "../../core/index.js";
import { ArnsClientManager } from "../utils/ArnsClientManager.js";
```

### File Locations and Naming

**New Files to Create**:

- `src/tools/arns/commands/GetArnsTokenCostCommand.ts` - Main command implementation
- `tests/unit/tools/arns/commands/GetArnsTokenCostCommand.unit.test.ts` - Unit tests

**Files to Modify**:

- `src/tools/arns/ArnsToolFactory.ts` - Add command to getToolClasses() array
- `src/tools/arns/commands/index.ts` - Add command export

**Naming Conventions** [Source: docs/architecture/coding-standards.md]:

- PascalCase with Command suffix for class names
- camelCase for method and variable names
- Descriptive parameter names matching ArNS terminology

## QA Results

### Review Date: 2025-01-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Comprehensive review completed on Story 10.3: ArNS Cost Calculation & Pricing implementation. The development team successfully delivered a robust ArNS cost calculation tool that exceeds expectations. Implementation demonstrates excellent architectural patterns, comprehensive error handling, and sophisticated fallback mechanisms.

**Key Strengths:**

- Excellent separation of concerns with clear interfaces and type definitions
- Comprehensive pricing API integration with graceful fallbacks
- Sophisticated break-even analysis and decision support features
- Robust parameter validation using Zod with conditional validation
- Well-structured test suite with 17 passing tests covering all scenarios

### Refactoring Performed

- **File**: src/tools/arns/commands/GetArnsTokenCostCommand.ts:186,204,212,270
  - **Change**: Replaced generic `any` types with specific type assertions for ar-io-sdk API calls
  - **Why**: Eliminates TypeScript eslint violations while maintaining runtime flexibility for incomplete SDK types
  - **How**: Used structured type assertions like `{ getTokenCost: (params) => Promise<number> }` for better type safety

### Compliance Check

- Coding Standards: ✓ Fully compliant after refactoring
- Project Structure: ✓ Follows ArNS tool patterns perfectly
- Testing Strategy: ✓ Comprehensive unit test coverage (17 tests)
- All ACs Met: ✓ All 6 tasks and acceptance criteria fulfilled

### Improvements Checklist

- [x] Fixed TypeScript eslint violations by replacing `any` types with structured assertions
- [x] Verified all 17 unit tests pass consistently
- [x] Confirmed comprehensive fallback pricing mechanism works correctly
- [x] Validated enhanced cost breakdown features with break-even analysis
- [x] Verified proper factory registration and MCP tool integration
- [x] Confirmed graceful error handling for all failure scenarios

### Security Review

No security concerns identified. Implementation properly validates all inputs through Zod schemas, handles external API failures gracefully, and follows secure coding practices. No sensitive data exposure or injection vulnerabilities detected.

### Performance Considerations

Excellent performance characteristics with appropriate fallback mechanisms. The pricing fallback system ensures functionality even when ar-io-sdk APIs are unavailable. Winston to IO token conversion is efficient and properly formatted. Network timeouts are handled appropriately.

### Files Modified During Review

- src/tools/arns/commands/GetArnsTokenCostCommand.ts - Type safety improvements (lines 186, 204, 212, 270, 454)

### Gate Status

Gate: PASS → docs/qa-gates/10.3-arns-cost-calculation-pricing.yml
Risk profile: Low complexity, well-tested financial calculation tool
NFR assessment: All non-functional requirements met with comprehensive error handling

### Recommended Status

✓ Ready for Done - Implementation exceeds requirements with sophisticated features and comprehensive test coverage. All acceptance criteria fully satisfied.

## Change Log

| Date       | Version | Description                                                                                                   | Author                 |
| ---------- | ------- | ------------------------------------------------------------------------------------------------------------- | ---------------------- |
| 2025-08-22 | 1.0     | Story created using BMad story creation task with comprehensive technical context from architecture documents | Claude Code (Sonnet 4) |
| 2025-01-27 | 1.1     | QA review completed with PASS gate status and Ready for Done recommendation                                   | Quinn (Test Architect) |
