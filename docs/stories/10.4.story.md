# Story 10.4: ArNS Registration Tools

## Status

Approved

## Story

**As a** user establishing decentralized identity,  
**I want** to register ArNS names through natural language commands so that **I can secure my desired names with appropriate registration types**.

## Acceptance Criteria

1. **BuyArnsRecordCommand Implementation**
   - Implement `BuyArnsRecordCommand` supporting both lease and permanent registration
   - Support lease duration selection (1-5 years) with proper validation
   - Implement permanent registration option with appropriate cost handling
   - Include referral tracking support for ar-io-sdk registration flow

2. **Transaction Signing Integration**
   - Integrate with existing signer management infrastructure for transaction signing
   - Use existing AutoSafeToolContext patterns for keyPair management
   - Support undername limit specification during registration
   - Provide transaction confirmation and status reporting

3. **Registration Flow Implementation**
   - Cost calculation integration with Story 10.3 pricing tools for pre-registration validation
   - Parameter validation for name format, duration, payment amounts
   - Transaction creation using ar-io-sdk `buyRecord()` with proper parameters
   - Error recovery handling for network failures, insufficient funds, name conflicts

4. **Integration & Error Handling**
   - Handle registration failures with clear error messages and retry guidance
   - Follow confirmation flow patterns from existing token tools
   - Transaction status monitoring and result reporting
   - Provide actionable user guidance for common failure scenarios

## Tasks / Subtasks

- [ ] **Task 1: Create BuyArnsRecordCommand Structure** (AC: 1)
  - [ ] Create `src/tools/arns/commands/BuyArnsRecordCommand.ts` following existing tool patterns
  - [ ] Implement ToolCommand base class extension with proper typing
  - [ ] Add comprehensive Zod parameter validation schema for registration requests
  - [ ] Include proper tool metadata and descriptions for AI usage

- [ ] **Task 2: Implement Core Registration Logic** (AC: 1, 3)
  - [ ] Integrate ar-io-sdk registration APIs (`buyRecord()` methods)
  - [ ] Implement duration-based registration logic for lease options (1-5 years)
  - [ ] Add permanent registration option with appropriate cost validation
  - [ ] Create registration parameter assembly utilities

- [ ] **Task 3: Add Transaction Signing Integration** (AC: 2)
  - [ ] Integrate with AutoSafeToolContext for keyPair management following existing patterns
  - [ ] Implement transaction creation and signing flow using ar-io-sdk
  - [ ] Add transaction confirmation and status reporting mechanisms
  - [ ] Support undername limit specification during registration

- [ ] **Task 4: Implement Cost Integration and Validation** (AC: 3)
  - [ ] Integrate with GetArnsTokenCostCommand from Story 10.3 for pre-registration cost validation
  - [ ] Add payment amount validation against calculated costs
  - [ ] Implement cost confirmation flow before transaction submission
  - [ ] Add cost mismatch error handling and guidance

- [ ] **Task 5: Add Registration Error Handling** (AC: 4)
  - [ ] Add comprehensive error handling for ar-io-sdk registration failures
  - [ ] Implement specific error handling for insufficient funds, name conflicts, network issues
  - [ ] Add retry mechanisms for transient failures
  - [ ] Provide clear error messages with actionable guidance

- [ ] **Task 6: Register Command in ArnsToolFactory** (AC: 4)
  - [ ] Add BuyArnsRecordCommand to ArnsToolFactory.getToolClasses()
  - [ ] Ensure proper command registration following existing patterns
  - [ ] Verify tool appears in MCP tool registry
  - [ ] Test command discovery and execution flow

- [ ] **Task 7: Create Unit Tests** (AC: 1, 2, 3, 4)
  - [ ] Create `tests/unit/tools/arns/commands/BuyArnsRecordCommand.unit.test.ts`
  - [ ] Mock ar-io-sdk registration API calls using Vitest vi.mock()
  - [ ] Test all registration scenarios (lease, permanent, undername limits)
  - [ ] Test transaction signing, error handling, and cost validation

## Dev Notes

### Previous Story Context

From Story 10.3 completion notes:

- ArNS cost calculation system fully operational with GetArnsTokenCostCommand
- Comprehensive pricing API integration with graceful fallbacks implemented
- Sophisticated break-even analysis and decision support features available
- Robust parameter validation using Zod with conditional validation established
- Well-structured test suite patterns with integration testing approach proven

From Story 10.2 completion insights:

- ArNS name resolution and validation utilities fully established
- ArnsClientManager singleton providing reliable client management and network switching
- Comprehensive ArNS name format validation using centralized utilities in ArnsNameValidation.ts
- Integration test patterns proven successful for ArNS client functionality
- Error handling patterns established for network issues and invalid name formats

From Story 10.1 foundational work:

- ArNS infrastructure established with ArnsClientManager singleton for network management
- ArNS directory structure created following project patterns: `src/tools/arns/`
- ArnsToolFactory ready for command registration with proper BaseToolFactory extension
- ar-io-sdk integration completed with network switching support (mainnet/testnet)
- Environment variable ARNS_NETWORK configured for network selection

### Technology Stack Integration

**Core Technologies** [Source: docs/architecture/tech-stack.md]:

- TypeScript 5.8+ with strict typing requirements
- FastMCP 1.27+ framework patterns for MCP tool implementation
- Node.js 20+ runtime environment
- AO Connect 0.0.85 for ecosystem integration
- Existing ar-io-sdk integration from previous stories

**ArNS-Specific Integration** [Source: previous story implementations]:

- ar-io-sdk registration APIs for name purchase operations
- Network support: Mainnet, Testnet configurations via ArnsClientManager
- IO token economics integration for payment processing
- Transaction signing compatible with existing Arweave wallet infrastructure

### Project Structure Alignment

**Tool Organization** [Source: docs/architecture/source-tree.md]:

```
src/tools/arns/                    # Existing ArNS tool category
├── ArnsToolFactory.ts             # Factory class (will be updated)
├── utils/
│   ├── ArnsClientManager.ts       # Client management singleton (available)
│   └── ArnsNameValidation.ts      # Name validation utilities (available)
├── commands/                      # Commands directory (ready for new command)
│   ├── GetArnsTokenCostCommand.ts # Cost calculation (available for integration)
│   ├── ResolveArnsNameCommand.ts  # Name resolution (available)
│   ├── GetArnsRecordInfoCommand.ts# Record info (available)
│   ├── BuyArnsRecordCommand.ts    # New file to create
│   └── index.ts                   # Will be updated with new export
└── index.ts                       # Main exports
```

**Factory Pattern Requirements** [Source: existing ArNS implementation]:

- Extend BaseToolFactory class from `../core/index.js`
- Add BuyArnsRecordCommand to getToolClasses() method array
- Follow naming conventions: PascalCase with Command suffix
- Use ToolContext interface for dependency injection

### Command Implementation Architecture

**ToolCommand Base Class Pattern** [Source: existing token tools]:

```typescript
export class BuyArnsRecordCommand extends ToolCommand<BuyArnsRecordArgs, string> {
  protected metadata: ToolMetadata = {
    description: "Register ArNS names through natural language commands supporting both lease and permanent registration with transaction signing",
    name: "buyArnsRecord",
    openWorldHint: false,
    readOnlyHint: false,
    title: "Buy ArNS Record",
  };

  protected parametersSchema = z.object({
    name: z.string().describe("ArNS name to register (without .ar suffix)"),
    type: z.enum(["lease", "permanent"]).describe("Registration type"),
    years: z.number().min(1).max(5).optional().describe("Lease duration (1-5 years, required for lease type)"),
    undernames: z.number().min(10).max(100).optional().describe("Number of undernames to support (default: 10)"),
    confirmed: z.boolean().optional().describe("Set to true to confirm registration"),
  });
```

**Integration with ArnsClientManager** [Source: existing ArNS commands]:

```typescript
import { ArnsClientManager } from "../utils/ArnsClientManager.js";

// In execute method:
const clientManager = ArnsClientManager.getInstance();
await clientManager.initializeFromEnvironment(); // Uses ARNS_NETWORK env var
const arnsClient = clientManager.getClient();
if (!arnsClient) {
  throw new Error("ArNS client not initialized");
}

// Use arnsClient for registration API calls
```

### ArNS Registration API Integration

**ar-io-sdk Registration Methods** [Source: ar-io-sdk documentation]:

```typescript
// Register name with lease option
const registrationResult = await arnsClient.buyRecord({
  name: "example", // name without .ar suffix
  years: 1, // for lease registration
  type: "lease" | "permanent",
  processId: "processId", // for undername limit specification
});

// Registration result structure:
interface RegistrationResult {
  id: string; // Transaction ID
  processId: string; // AR.IO process ID
  target?: string; // Target address
  owner: string; // Registration owner
  tags: Array<{ name: string; value: string }>; // Transaction tags
}
```

**Registration Flow Implementation**:

- **Cost Pre-validation**: Use GetArnsTokenCostCommand for cost estimation and confirmation
- **Parameter Assembly**: Build registration parameters with proper validation
- **Transaction Creation**: Use ar-io-sdk `buyRecord()` with signed parameters
- **Status Monitoring**: Track transaction confirmation and provide status updates
- **Error Recovery**: Handle failures with clear guidance for retry scenarios

### Transaction Signing Integration

**AutoSafeToolContext Integration** [Source: existing token tools]:

```typescript
// Follow existing token tool patterns
const autoContext = AutoSafeToolContext.from(this.context);
const { hubId, keyPair, publicKey } = await autoContext.initializeAll();

// Use keyPair for transaction signing via ar-io-sdk
const signedTransaction = await arnsClient.buyRecord({
  name: validatedName,
  type: registrationType,
  years: leaseDuration,
  signer: keyPair, // Use existing keypair management
});
```

**Confirmation Flow Pattern** [Source: TransferTokensCommand analysis]:

- Pre-validation of parameters and costs
- Confirmation requirement for significant transactions
- Clear response messaging for confirmation requirements
- Status reporting after successful registration

### Error Handling Requirements

**Error Handling Standards** [Source: docs/architecture/coding-standards.md]:

- Comprehensive try-catch blocks with meaningful error messages
- Proper error propagation and logging
- Graceful failure management

**ArNS Registration-Specific Error Scenarios**:

- Network connectivity issues (retry mechanisms)
- Invalid name format or availability conflicts
- Insufficient funds for registration costs
- Transaction signing failures
- SDK registration API errors

**Error Response Pattern** [Source: existing tool analysis]:

```typescript
// Error response format
{
  success: false,
  error: "REGISTRATION_FAILED",
  message: "Detailed error message",
  suggestion: "Actionable guidance for user",
  details: {
    name: registrationName,
    type: registrationType,
    estimatedCost: calculatedCost,
    // ... other relevant context
  }
}
```

### Parameter Validation and Types

**Zod Schema Validation Patterns** [Source: existing ArNS tool patterns]:

```typescript
const parametersSchema = z.object({
  name: z
    .string()
    .min(1)
    .max(51) // ArNS name length limits
    .regex(/^[a-zA-Z0-9-]+$/) // Valid ArNS characters, no .ar suffix
    .describe("ArNS name to register (without .ar suffix)"),

  type: z
    .enum(["lease", "permanent"])
    .describe(
      "Registration type - lease for 1-5 years, permanent for lifetime ownership",
    ),

  years: z
    .number()
    .int()
    .min(1)
    .max(5)
    .optional()
    .describe("Lease duration in years (1-5, required for lease type)"),

  undernames: z
    .number()
    .int()
    .min(10)
    .max(100)
    .optional()
    .default(10)
    .describe("Number of undernames to support (10-100, default: 10)"),

  network: z
    .enum(["mainnet", "testnet"])
    .optional()
    .describe(
      "Network to use for registration (defaults to ARNS_NETWORK env var)",
    ),

  confirmed: z
    .boolean()
    .optional()
    .describe("Set to true to confirm registration"),
});
```

**Conditional Validation Logic**:

- Years parameter required when type is "lease"
- Name format validation for ArNS compliance (no .ar suffix in parameter)
- Network parameter validation with environment variable fallback
- Cost confirmation validation before transaction submission

### Cost Integration with Story 10.3

**GetArnsTokenCostCommand Integration** [Source: Story 10.3 implementation]:

```typescript
// Import and use existing cost calculation
import { GetArnsTokenCostCommand } from "./GetArnsTokenCostCommand.js";

// In BuyArnsRecordCommand execute method:
const costCommand = new GetArnsTokenCostCommand(this.context);
const costResult = await costCommand.execute({
  name: args.name,
  type: args.type,
  years: args.years,
  undernames: args.undernames,
  network: args.network,
});

const costData = JSON.parse(costResult);
if (!costData.success) {
  return JSON.stringify({
    success: false,
    error: "COST_CALCULATION_FAILED",
    message: "Could not calculate registration cost",
    suggestion: "Check name availability and network connectivity",
  });
}

// Validate user has confirmed the cost
if (!args.confirmed) {
  return JSON.stringify({
    success: false,
    requiresConfirmation: true,
    message: `Registration will cost ${costData.pricing.breakdown.totalCostIO} IO tokens`,
    estimatedCost: costData.pricing,
    instruction: "Add 'confirmed: true' to proceed with registration",
  });
}
```

### Response Format Specification

**Structured Response Format** [Source: existing tool patterns]:

```typescript
interface BuyArnsRecordResponse {
  success: boolean;
  transactionId?: string;
  registration?: {
    name: string;
    type: "lease" | "permanent";
    years?: number;
    undernames: number;
    network: string;
    owner: string;
    cost: {
      totalPaid: string; // IO tokens
      breakdown: object; // Cost breakdown details
    };
  };
  error?: {
    code: string;
    message: string;
    suggestions: string[];
  };
  requiresConfirmation?: boolean;
  instruction?: string;
  estimatedCost?: object;
}
```

### Testing Requirements

**Unit Testing Standards** [Source: existing ArNS test patterns]:

Test file: `tests/unit/tools/arns/commands/BuyArnsRecordCommand.unit.test.ts`

```typescript
// Mock ar-io-sdk dependencies
vi.mock("@ar.io/sdk/node", () => ({
  ARIO: {
    mainnet: vi.fn(),
    testnet: vi.fn(),
  },
}));

// Mock ArnsClientManager
vi.mock("../../../src/tools/arns/utils/ArnsClientManager.js", () => ({
  ArnsClientManager: {
    getInstance: vi.fn(),
  },
}));

// Mock GetArnsTokenCostCommand for cost integration testing
vi.mock("../../../src/tools/arns/commands/GetArnsTokenCostCommand.js", () => ({
  GetArnsTokenCostCommand: vi.fn(),
}));

describe("BuyArnsRecordCommand", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe("Parameter Validation", () => {
    it("should validate lease type requires years parameter", async () => {
      // Test conditional validation logic
    });

    it("should validate name format and length", async () => {
      // Test ArNS name validation without .ar suffix
    });

    it("should validate undername limits", async () => {
      // Test 10-100 range validation
    });
  });

  describe("Registration Flow", () => {
    it("should perform lease registration with proper parameters", async () => {
      // Test lease registration flow
    });

    it("should perform permanent registration", async () => {
      // Test permanent registration flow
    });

    it("should integrate cost calculation for confirmation", async () => {
      // Test cost integration and confirmation flow
    });
  });

  describe("Transaction Signing", () => {
    it("should use AutoSafeToolContext for keyPair management", async () => {
      // Test transaction signing integration
    });

    it("should handle signing failures gracefully", async () => {
      // Test signing error scenarios
    });
  });

  describe("Error Handling", () => {
    it("should handle registration failures with clear messages", async () => {
      // Test registration failure scenarios
    });

    it("should handle network timeout scenarios", async () => {
      // Test timeout and retry logic
    });

    it("should handle insufficient funds errors", async () => {
      // Test payment failure scenarios
    });
  });
});
```

**Key Test Scenarios**:

- Parameter validation for all registration combinations
- Cost calculation integration and confirmation flow
- Transaction signing using existing keyPair management
- Registration success scenarios with proper response formatting
- Error handling for network failures, insufficient funds, name conflicts
- Network switching and client management integration

### Integration with Existing Infrastructure

**ToolContext Usage** [Source: existing tool patterns]:

- BuyArnsRecordCommand receives ToolContext containing keyPair, publicKey, hubId
- ArnsClientManager integration for network-aware registration
- AutoSafeToolContext patterns for initialization and keyPair management

**Performance Considerations**:

- ArNS client reuse through existing singleton pattern
- Cost calculation integration to avoid redundant API calls
- Transaction confirmation monitoring with appropriate timeouts
- Network timeout configuration following existing patterns

### Dependencies and Integration

**Existing Dependencies** (from previous stories):

- ar-io-sdk: Already installed and configured
- ArnsClientManager: Available for client management
- GetArnsTokenCostCommand: Available for cost integration
- ArnsNameValidation: Available for name validation utilities
- ArnsToolFactory: Ready for command registration

**Import Patterns**:

```typescript
import { z } from "zod";
import { ARIO } from "@ar.io/sdk/node";
import {
  AutoSafeToolContext,
  ToolCommand,
  ToolContext,
  ToolMetadata,
} from "../../core/index.js";
import { ArnsClientManager } from "../utils/ArnsClientManager.js";
import { GetArnsTokenCostCommand } from "./GetArnsTokenCostCommand.js";
import { isValidArnsName } from "../utils/ArnsNameValidation.js";
```

### File Locations and Naming

**New Files to Create**:

- `src/tools/arns/commands/BuyArnsRecordCommand.ts` - Main registration command implementation
- `tests/unit/tools/arns/commands/BuyArnsRecordCommand.unit.test.ts` - Unit tests

**Files to Modify**:

- `src/tools/arns/ArnsToolFactory.ts` - Add command to getToolClasses() array
- `src/tools/arns/commands/index.ts` - Add command export

**Naming Conventions** [Source: docs/architecture/coding-standards.md]:

- PascalCase with Command suffix for class names
- camelCase for method and variable names
- Descriptive parameter names matching ArNS registration terminology

## Project Structure Notes

The existing ArNS tool structure aligns perfectly with the registration tool requirements:

- **ArnsToolFactory.ts**: Ready for new command registration following established patterns
- **utils/ArnsClientManager.ts**: Provides network-aware client management for registration operations
- **utils/ArnsNameValidation.ts**: Provides centralized name validation utilities for input validation
- **commands/GetArnsTokenCostCommand.ts**: Provides cost calculation integration for registration confirmation
- **Directory Structure**: Follows established patterns with clear separation of commands, utilities, and factory classes

No structural conflicts identified - the new BuyArnsRecordCommand integrates seamlessly with existing infrastructure.

## Change Log

| Date       | Version | Description                                                                                                   | Author                 |
| ---------- | ------- | ------------------------------------------------------------------------------------------------------------- | ---------------------- |
| 2025-08-22 | 1.0     | Story created using BMad story creation task with comprehensive technical context from architecture documents | Claude Code (Sonnet 4) |

## QA Results

### Review Date: 2025-08-22

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation demonstrates solid architectural understanding and follows established patterns from previous ArNS stories. The `BuyArnsRecordCommand` is well-structured with comprehensive parameter validation, proper error handling patterns, and integration with existing ArNS infrastructure. However, significant issues exist in the test suite that indicate underlying implementation problems with the ar-io-sdk integration and mocking strategies.

### Refactoring Performed

None - The implementation quality is generally acceptable, but critical issues with test failures indicate deeper problems requiring developer attention rather than cosmetic refactoring.

### Compliance Check

- Coding Standards: ✗ **Test implementation fails to properly mock ar-io-sdk dynamics**
- Project Structure: ✓ Follows established ArNS tool patterns correctly
- Testing Strategy: ✗ **49 out of 95 tests failing with mock isolation issues**
- All ACs Met: ✗ **Core registration functionality not properly tested due to mock failures**

### Improvements Checklist

[Critical issues requiring developer attention - all left unchecked for dev to address]

- [ ] **CRITICAL: Fix ar-io-sdk mocking strategy in BuyArnsRecordCommand tests**
  - Current issue: Tests fail because dynamic imports are not properly mocked
  - 12/19 tests failing with mock timing and isolation problems
  - Error pattern: `expected false to be true` indicates registration flow not working

- [ ] **CRITICAL: Fix mock isolation issues across ArNS command test suite**
  - TransferArnsRecordCommand: 19/23 tests failing
  - UpdateArnsRecordCommand: 18/23 tests failing
  - GetArnsTokenCostCommand: Tests showing "arnsClient.getTokenCost is not a function" errors

- [ ] **PRIORITY: Implement proper cost calculation integration testing**
  - BuyArnsRecordCommand shows inconsistent behavior in confirmation flow
  - Cost calculation mocking needs alignment with GetArnsTokenCostCommand patterns

- [ ] **PRIORITY: Verify ar-io-sdk API compatibility**
  - ExtendedARIO interface may not match actual SDK methods
  - `buyRecord`, `transferRecord`, `updateRecord` method signatures need verification

- [ ] **ENHANCEMENT: Improve error handling specificity**
  - Current pattern matches are too broad (e.g., "insufficient funds" detection)
  - Need more precise error code classification

### Security Review

**PASS** - No security concerns identified. The implementation properly:

- Validates input parameters with Zod schemas
- Uses AutoSafeToolContext for secure keyPair management
- Implements confirmation flows for sensitive operations
- Handles authorization through existing ArNS ownership verification

### Performance Considerations

**CONCERNS** - Several potential issues:

- Multiple client initialization calls may cause performance overhead
- Dynamic imports within execution path could impact response times
- Cost calculation integration creates additional API calls before registration
- No caching strategy for repeated ArNS client operations

### Files Modified During Review

None modified during review - issues require developer investigation and resolution.

### Gate Status

Gate: FAIL → docs/qa/gates/10.4-arns-registration-tools.yml
Risk profile: docs/qa/assessments/10.4-risk-20250822.md  
NFR assessment: docs/qa/assessments/10.4-nfr-20250822.md

### Recommended Status

**✗ Changes Required - Critical test failures block story completion**

The story implementation has good architectural foundation but cannot be considered complete due to:

1. **49 failing tests** across the ArNS command suite indicating systematic mocking issues
2. **Core registration functionality** not demonstrably working due to ar-io-sdk integration problems
3. **Test isolation failures** suggesting broader infrastructure problems beyond this story

**Developer Action Required:**

1. Investigate and fix ar-io-sdk mocking strategy
2. Resolve dynamic import mocking in test environment
3. Verify actual ar-io-sdk API compatibility with implemented interfaces
4. Ensure proper test isolation across ArNS command test suite
5. Validate end-to-end registration flow with corrected mocks

Story owner should not mark as Done until all tests pass and registration flow is verified functional.
