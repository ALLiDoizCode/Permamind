# Story 11.6: Browser Wallet Upload Architecture Refactor

<!-- Powered by BMAD™ Core -->

## Status

Draft

## Story

**As a** Permamind user with a browser wallet,
**I want** to publish skills using my browser wallet (ArConnect/Wander) through the CLI,
**so that** I don't need to manage seed phrases or JWK files for skill publishing.

## Story Context

**Existing System Integration:**
- Builds on: Stories 11.1-11.5 (Browser wallet connection, signing, error handling complete)
- Current limitation: PublishService upload flow requires JWK (browser wallets cannot export JWK)
- Current working: Browser wallet signing via `signDataItem()` API (validated in tests)
- Current blocker: Upload path (`arweave-client.ts`, `turbo-init.ts`) requires JWK parameter
- Technology: TypeScript 5.3.3, Node.js 20.11.0 LTS, node-arweave-wallet ^0.0.12
- Touch points:
  - `cli/src/lib/publish-service.ts` (loadWallet() method - returns JWK)
  - `cli/src/clients/arweave-client.ts` (uploadBundle(JWK) signature)
  - `cli/src/lib/turbo-init.ts` (initializeTurboClient(JWK))
  - `cli/src/commands/publish.ts` (CLI entry point)

**What's being enhanced:**
- Refactor upload chain to accept `IWalletProvider` instead of `JWK`
- Polymorphic upload based on wallet type (seed/file → JWK path, browser → dispatch path)
- Create browser wallet-specific upload using `dispatch()` API
- Maintain full backward compatibility with SEED_PHRASE and file wallets
- Preserve Turbo SDK free tier for all wallet types

**Success criteria:**
- Browser wallets can publish skills via CLI `skills publish` command
- SEED_PHRASE wallets continue using Turbo SDK free tier (< 100KB) unchanged
- File wallets continue working unchanged
- All three wallet types can publish skills successfully
- Zero breaking changes to existing upload logic
- Turbo SDK free tier still works for seed phrase and file wallets

## Acceptance Criteria

### AC 1: Refactor PublishService.loadWallet to loadWalletProvider
- [ ] Rename `loadWallet()` to `loadWalletProvider()`
- [ ] Change return type from `Promise<JWK>` to `Promise<IWalletProvider>`
- [ ] Remove browser wallet JWK export check (no longer needed)
- [ ] Maintain backward compatibility for deprecated `wallet` and `walletPath` options
- [ ] Wrap legacy JWK in `SeedPhraseWalletProvider` for consistent interface

**Validation**:
```typescript
// Before: Returns JWK (browser wallets fail)
const wallet = await this.loadWallet(options);

// After: Returns IWalletProvider (all wallet types work)
const walletProvider = await this.loadWalletProvider(options);
```

### AC 2: Refactor arweave-client.uploadBundle Signature
- [ ] Change signature from `uploadBundle(bundle, metadata, wallet: JWK, ...)` to `uploadBundle(bundle, metadata, walletProvider: IWalletProvider, ...)`
- [ ] Extract JWK from walletProvider when needed (seed/file wallets only)
- [ ] Route browser wallets to new upload path
- [ ] Preserve existing Turbo SDK and Arweave SDK logic for seed/file wallets

**Validation**:
```typescript
// Polymorphic upload based on wallet type
const source = walletProvider.getSource();
if (source.source === 'seedPhrase' || source.source === 'file') {
  const jwk = await walletProvider.getJWK();
  // Use existing Turbo/Arweave SDK logic
} else if (source.source === 'browserWallet') {
  // Use new browser wallet upload path
}
```

### AC 3: Implement uploadBundleWithBrowserWallet
- [ ] Create new function `uploadBundleWithBrowserWallet(bundle, metadata, walletProvider, options)`
- [ ] Use browser wallet's `dispatch()` API for direct Arweave upload
- [ ] Support bundle tagging (Content-Type, App-Name, Skill-Name, Skill-Version)
- [ ] Return IUploadResult compatible with existing flow
- [ ] Handle upload errors with proper NetworkError wrapping

**Implementation Pattern**:
```typescript
async function uploadBundleWithBrowserWallet(
  bundle: Buffer,
  metadata: IBundleMetadata,
  walletProvider: IWalletProvider,
  options?: IUploadOptions
): Promise<IUploadResult> {
  // Get NodeArweaveWallet instance
  const wallet = (walletProvider as BrowserWalletProvider)._adapter.wallet;

  // Create transaction
  const tx = await arweave.createTransaction({ data: bundle });
  tx.addTag('Content-Type', 'application/x-gzip');
  tx.addTag('Skill-Name', metadata.skillName);
  tx.addTag('Skill-Version', metadata.version);

  // Dispatch (sign + upload in one call)
  const result = await wallet.dispatch(tx);

  return {
    txId: result.id,
    size: bundle.length,
    cost: 0, // Browser wallet doesn't expose cost
  };
}
```

### AC 4: Update PublishService.publish Workflow
- [ ] Update workflow to pass `walletProvider` to `uploadBundle()`
- [ ] Remove `loadWallet()` call, replace with `loadWalletProvider()`
- [ ] Ensure all tests pass with new signature
- [ ] Validate backward compatibility with deprecated options

### AC 5: Turbo SDK Free Tier Compatibility
- [ ] Verify SEED_PHRASE wallets still use Turbo SDK for < 100KB bundles
- [ ] Verify file wallets still use Turbo SDK for < 100KB bundles
- [ ] Verify free tier uploads still work (no cost)
- [ ] Confirm ArDrive subsidized uploads functional

**Test Matrix**:
| Wallet Type | Bundle Size | Expected Path | Free Tier |
|-------------|-------------|---------------|-----------|
| SEED_PHRASE | < 100KB | Turbo SDK | ✅ Free |
| SEED_PHRASE | >= 100KB | Arweave SDK | ❌ Paid |
| File | < 100KB | Turbo SDK | ✅ Free |
| File | >= 100KB | Arweave SDK | ❌ Paid |
| Browser | Any | Browser dispatch | ✅ Free |

### AC 6: Backward Compatibility
- [ ] Deprecated `wallet` option still works (wrapped in provider)
- [ ] Deprecated `walletPath` option still works (loaded as provider)
- [ ] All existing tests pass without modification
- [ ] No breaking changes to PublishService API

### AC 7: End-to-End Validation
- [ ] CLI publish with browser wallet succeeds
- [ ] Arweave transaction ID returned
- [ ] Skill bundle uploaded to Arweave
- [ ] AO registry registration completes
- [ ] No circular reference errors in any code path
- [ ] Browser wallet disconnects properly after publish

## Tasks / Subtasks

- [ ] Task 1: Refactor PublishService (AC 1, 4)
  - [ ] Rename `loadWallet()` to `loadWalletProvider()`
  - [ ] Update return type to `IWalletProvider`
  - [ ] Update `publish()` workflow to use `walletProvider`
  - [ ] Add backward compatibility wrappers for deprecated options
  - [ ] Update internal method calls

- [ ] Task 2: Refactor arweave-client.uploadBundle (AC 2)
  - [ ] Change signature to accept `IWalletProvider`
  - [ ] Add wallet type detection logic
  - [ ] Route seed/file wallets to existing paths (extract JWK)
  - [ ] Route browser wallets to new upload path
  - [ ] Preserve all existing Turbo/Arweave SDK logic

- [ ] Task 3: Implement Browser Wallet Upload Path (AC 3)
  - [ ] Create `uploadBundleWithBrowserWallet()` function
  - [ ] Implement using NodeArweaveWallet `dispatch()` API
  - [ ] Add proper error handling and NetworkError wrapping
  - [ ] Return IUploadResult format
  - [ ] Add logging for debugging

- [ ] Task 4: Update Dependent Code (AC 4, 6)
  - [ ] Update PublishService.publish() to call loadWalletProvider()
  - [ ] Update PublishService.uploadBundle() call signature
  - [ ] Test backward compatibility with deprecated options
  - [ ] Verify no breaking changes

- [ ] Task 5: Validation Testing (AC 5, 7)
  - [ ] Test SEED_PHRASE wallet with < 100KB bundle (Turbo free tier)
  - [ ] Test file wallet with < 100KB bundle (Turbo free tier)
  - [ ] Test browser wallet with any bundle size
  - [ ] Verify all uploads reach Arweave successfully
  - [ ] Verify AO registry registration works for all wallet types
  - [ ] Test circular reference fix still working

- [ ] Task 6: Integration Testing
  - [ ] Create end-to-end test: browser wallet → upload → registry
  - [ ] Test error scenarios (timeout, rejection, network failure)
  - [ ] Verify cleanup/disconnect in all code paths
  - [ ] Test all three wallet types in sequence

## Dev Notes

### Relevant Source Tree

**Core Files to Modify**:
```
cli/src/lib/publish-service.ts
├─ loadWallet() → loadWalletProvider() [REFACTOR]
├─ publish() workflow [UPDATE]
└─ uploadBundle() call [UPDATE]

cli/src/clients/arweave-client.ts
├─ uploadBundle(JWK) → uploadBundle(IWalletProvider) [REFACTOR]
├─ uploadBundleWithTurboSDK() [KEEP - extract JWK for seed/file]
├─ uploadBundleWithArweaveSDK() [KEEP - extract JWK for seed/file]
└─ uploadBundleWithBrowserWallet() [NEW - browser wallet dispatch]

cli/src/commands/publish.ts
└─ execute() [ALREADY UPDATED - using walletProvider]
```

**Wallet Provider Interface** (`cli/src/types/wallet.ts`):
```typescript
interface IWalletProvider {
  getAddress(): Promise<string>;
  createDataItemSigner(): Promise<DataItemSigner>;
  disconnect?(): Promise<void>;
  getSource(): { source: 'seedPhrase' | 'browserWallet' | 'file'; value: string };
  getJWK?(): Promise<JWK>; // Optional - only seed/file wallets
}
```

**Browser Wallet Specifics**:
- `BrowserWalletProvider` does NOT have `getJWK()` method (security restriction)
- Uses `signDataItem()` for signing (already working)
- Needs `dispatch()` for upload (to be implemented)
- Contains HTTP server requiring cleanup (already handled)

**Turbo SDK Free Tier Requirements**:
- Bundles < 100KB eligible for free uploads
- `initializeTurboClient()` requires JWK for authentication
- Must extract JWK from seed/file wallets: `await walletProvider.getJWK()`
- Browser wallets bypass Turbo SDK (use dispatch instead)

**Upload Flow Decision Tree**:
```
uploadBundle(walletProvider)
├─ if (source === 'seedPhrase' || source === 'file')
│   ├─ jwk = await walletProvider.getJWK()
│   ├─ if (size < 100KB) → uploadBundleWithTurboSDK(jwk) [FREE]
│   └─ if (size >= 100KB) → uploadBundleWithArweaveSDK(jwk) [PAID]
└─ if (source === 'browserWallet')
    └─ uploadBundleWithBrowserWallet(walletProvider) [FREE via dispatch]
```

### Testing

**Test File Locations**:
- Unit tests: `cli/tests/unit/lib/publish-service.test.ts`
- Unit tests: `cli/tests/unit/clients/arweave-client.test.ts`
- Integration tests: `cli/tests/integration/publish-service.integration.test.ts`
- Browser wallet tests: `cli/tests/integration/wallet-manager-fallback.test.ts`

**Testing Standards**:
- Jest framework with TypeScript
- Test all three wallet types (seed, file, browser)
- Mock external services (Arweave, Turbo, AO)
- Integration tests for end-to-end flows
- Validate backward compatibility

**Critical Test Scenarios**:
1. SEED_PHRASE + small bundle → Turbo free tier
2. SEED_PHRASE + large bundle → Arweave SDK
3. File wallet + small bundle → Turbo free tier
4. Browser wallet + any bundle → Browser dispatch
5. Backward compat: deprecated `wallet` option
6. Backward compat: deprecated `walletPath` option

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-04 | 1.0 | Initial story creation for browser wallet upload refactor | Sarah (PO) |

## Dev Agent Record

*This section will be populated during implementation*

## QA Results

*This section will be populated by QA agent after implementation*
