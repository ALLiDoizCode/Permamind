# Story 12.1 Completion Steps

## Current Status
✅ **95% Complete** - All code written, tested, documented, and pushed to GitHub
⚠️ **Blocked**: Task 4 (npm publishing) requires infrastructure setup

## What's Complete

### Fork Repository (https://github.com/ALLiDoizCode/node-arweave-wallet)
- ✅ Custom branch created: `permamind-custom-ui`
- ✅ Custom template configuration implemented
- ✅ Unit tests written (Vitest)
- ✅ Package.json updated for @permamind scope
- ✅ Fork maintenance documentation created
- ✅ All changes committed and pushed to GitHub

### Permamind CLI
- ✅ package.json updated to use `@permamind/node-arweave-wallet@^0.0.13`
- ✅ Import statements updated
- ✅ Tech stack documentation updated
- ✅ Story documentation complete

## Remaining Steps to Complete Story 12.1

### Step 1: Fix pnpm Setup (Prerequisites)

**Problem**: Fork repository uses pnpm@10.17.1 with `catalog:` protocol, which requires specific setup.

**Solution Options**:

**Option A: Fix pnpm permissions** (Recommended)
```bash
# Fix pnpm directory permissions
sudo chown -R $(whoami) /Users/jonathangreen/Library/pnpm

# Or completely remove and reinstall
rm -rf /Users/jonathangreen/Library/pnpm
corepack enable
corepack prepare pnpm@10.17.1 --activate
```

**Option B: Use npx to run pnpm** (Alternative)
```bash
cd /Users/jonathangreen/Documents/node-arweave-wallet
npx pnpm@10.17.1 install
npx pnpm@10.17.1 run build
npx pnpm@10.17.1 test
```

**Option C: Convert package.json to use npm** (Last resort)
- Replace `catalog:` dependencies with specific versions
- Use npm instead of pnpm
- Less ideal as it diverges from upstream

### Step 2: Build and Test Fork

Once pnpm is working:

```bash
cd /Users/jonathangreen/Documents/node-arweave-wallet

# Install dependencies
pnpm install

# Build the fork
pnpm run build

# Verify build artifacts
ls -la dist/
# Should contain: index.js, index.d.ts, signer/ directory

# Run tests
pnpm test

# Verify all tests pass, including custom-template.test.ts
```

**Expected Results**:
- Build should succeed with no TypeScript errors
- All existing tests should pass (upstream tests)
- New custom template tests should pass (7 test cases)
- dist/ directory should contain compiled output

### Step 3: Publish to npm

**Prerequisites**:
- npm account with access to @permamind organization
- 2FA enabled on npm account

**Commands**:
```bash
cd /Users/jonathangreen/Documents/node-arweave-wallet

# Login to npm (if not already logged in)
npm login
# Enter credentials for account with @permamind scope access

# Verify login
npm whoami

# Publish the package
pnpm publish

# The package is already configured with:
# - name: @permamind/node-arweave-wallet
# - version: 0.0.13
# - publishConfig: { access: "public" }
```

**Verify Publication**:
```bash
# Check package is published
npm view @permamind/node-arweave-wallet

# Should show:
# - name: @permamind/node-arweave-wallet
# - version: 0.0.13
# - description: Fork with custom UI template support
```

### Step 4: Install and Test in Permamind CLI

```bash
cd /Users/jonathangreen/Documents/Permamind

# Install dependencies (will pull @permamind/node-arweave-wallet@^0.0.13)
npm install

# Verify correct package installed
npm list @permamind/node-arweave-wallet
# Should show: @permamind/node-arweave-wallet@0.0.13

# Build CLI
npm run build

# Run tests
npm test

# Verify all tests pass (especially wallet-related tests)
```

### Step 5: Manual Testing (Browser Wallet Integration)

Test the fork with actual browser wallet connection:

```bash
cd /Users/jonathangreen/Documents/Permamind

# Run a command that uses browser wallet
npm run cli:dev -- publish skills/ao-basics/

# Expected behavior:
# 1. Local server starts on random port
# 2. Browser opens with wallet connection UI
# 3. ArConnect/Wander prompts for permissions
# 4. CLI continues after wallet connection
# 5. No errors or warnings related to wallet library
```

**Validation Checklist**:
- [ ] Browser wallet connection works (ArConnect/Wander)
- [ ] Random port allocation works (no conflicts)
- [ ] Permission handling works (ACCESS_ADDRESS, SIGN_TRANSACTION, DISPATCH)
- [ ] Transaction signing works (uploads to Arweave)
- [ ] No regression from Epic 11 wallet workflows
- [ ] No breaking changes to existing functionality

### Step 6: Update Story Status

Once Steps 1-5 complete:

```bash
cd /Users/jonathangreen/Documents/Permamind

# Update story file
# Change Status from "In Progress (95% Complete - Blocked on Task 4)"
# To: "Ready for Review"

# Mark Task 4 subtasks as complete in docs/stories/12.1.story.md:
# - [x] Build fork: `pnpm run build`
# - [x] Verify build artifacts
# - [x] Publish to npm: `pnpm publish`
# - [x] Verify package published and installable

# Also mark Task 5 blocked subtasks as complete:
# - [x] Run `npm install` in CLI project
# - [x] Verify TypeScript compilation
# - [x] Run CLI tests and verify all pass
# - [x] Test browser wallet connection workflow manually

# Commit the update
git add docs/stories/12.1.story.md
git commit -m "Story 12.1: Mark as Ready for Review after npm publish"
```

## Troubleshooting

### Issue: pnpm install fails with catalog: protocol error
**Solution**: Ensure pnpm@10.17.1 is installed via corepack:
```bash
corepack enable
corepack prepare pnpm@10.17.1 --activate
pnpm --version  # Should show 10.17.1
```

### Issue: npm publish fails with 403 Forbidden
**Solution**: Ensure you're logged into npm with @permamind org access:
```bash
npm login
npm org ls permamind  # Should show your user
```

### Issue: Build fails with TypeScript errors
**Solution**: This shouldn't happen as code is tested, but if it does:
1. Check fork branch: `git checkout permamind-custom-ui`
2. Review recent commits: `git log --oneline`
3. Check for conflicts: `git status`

### Issue: Tests fail after installation
**Solution**: Check specific test failures:
```bash
pnpm test -- custom-template.test.ts  # Run only custom template tests
pnpm test -- --verbose  # Run all tests with verbose output
```

### Issue: CLI tests fail after installing fork
**Solution**:
1. Verify package version: `npm list @permamind/node-arweave-wallet`
2. Check import paths: `grep -r "@permamind/node-arweave-wallet" cli/src/`
3. Run specific test: `npm test -- --testPathPattern=wallet`

## Timeline Estimate

- **Step 1 (pnpm fix)**: 15-30 minutes
- **Step 2 (build/test fork)**: 5-10 minutes
- **Step 3 (npm publish)**: 5 minutes
- **Step 4 (CLI install/test)**: 10-15 minutes
- **Step 5 (manual testing)**: 15-30 minutes
- **Step 6 (update story)**: 5 minutes

**Total**: 1-2 hours (mostly waiting for installations/builds)

## Success Criteria

✅ Fork built successfully with no errors
✅ All fork tests pass (including custom template tests)
✅ Package published to npm: `@permamind/node-arweave-wallet@0.0.13`
✅ CLI installs fork without errors
✅ CLI builds successfully
✅ CLI tests pass (no regressions)
✅ Browser wallet connection works in manual testing
✅ Story status updated to "Ready for Review"

## Notes

- **Fork location**: `/Users/jonathangreen/Documents/node-arweave-wallet`
- **Fork branch**: `permamind-custom-ui`
- **Fork GitHub**: https://github.com/ALLiDoizCode/node-arweave-wallet/tree/permamind-custom-ui
- **CLI location**: `/Users/jonathangreen/Documents/Permamind`
- **Story file**: `docs/stories/12.1.story.md`

## Next Story

After Story 12.1 is complete, **Story 12.2** will create the actual custom HTML template using the fork's `customHtmlTemplatePath` configuration option.

---

**Document Created**: 2025-11-04
**Last Updated**: 2025-11-04
**Status**: Awaiting Step 1 (pnpm setup)
