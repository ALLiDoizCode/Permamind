# Story 3.1: Simplify Memory Tools to Core Functions

## Status

Done

## Story

**As a** developer working with the Permamind MCP server,
**I want** to simplify the memory tools to just the core store and search functions,
**so that** the MVP architecture focuses on essential functionality while maintaining all existing memory storage and retrieval capabilities.

## Acceptance Criteria

1. Remove complex memory tools: AddMemoriesBatchCommand, AddMemoryEnhancedCommand, AddReasoningChainCommand, GetAllMemoriesCommand, GetAllMemoriesForConversationCommand, GetMemoryAnalyticsCommand, LinkMemoriesCommand, SearchMemoriesAdvancedCommand
2. Keep only: AddMemoryCommand (renamed to storeMemory), SearchMemoriesCommand (renamed to searchMemory)
3. Update MemoryToolFactory to register only the 2 essential tools
4. Preserve underlying aiMemoryService functionality
5. Update tool descriptions to focus on MVP use cases

## Tasks / Subtasks

- [ ] **Analysis Phase - Current Memory Tools Assessment** (AC: 1)
  - [ ] Audit current memory tool commands to identify what exists vs what needs to be removed
  - [ ] Verify current tool names and registration patterns
  - [ ] Check if complex memory tools already exist or need to be removed
  - [ ] Document current state vs story requirements

- [ ] **Remove Complex Memory Tools** (AC: 1)
  - [ ] Remove AddMemoriesBatchCommand if it exists
  - [ ] Remove AddMemoryEnhancedCommand if it exists
  - [ ] Remove AddReasoningChainCommand if it exists
  - [ ] Remove GetAllMemoriesCommand if it exists
  - [ ] Remove GetAllMemoriesForConversationCommand if it exists
  - [ ] Remove GetMemoryAnalyticsCommand if it exists
  - [ ] Remove LinkMemoriesCommand if it exists
  - [ ] Remove SearchMemoriesAdvancedCommand if it exists
  - [ ] Remove any associated test files for deleted commands
  - [ ] Remove any references to deleted commands in index.ts files

- [ ] **Update Core Memory Tools** (AC: 2)
  - [ ] Verify AddMemoryCommand is properly named "storeMemory" in tool metadata
  - [ ] Verify SearchMemoriesCommand is properly named "searchMemory" in tool metadata
  - [ ] Update tool descriptions to focus on MVP use cases
  - [ ] Ensure proper parameter validation with Zod schemas
  - [ ] Verify error handling follows project standards

- [ ] **Update MemoryToolFactory** (AC: 3)
  - [ ] Modify MemoryToolFactory to register only AddMemoryCommand and SearchMemoriesCommand
  - [ ] Update category description to reflect simplified MVP focus
  - [ ] Verify proper tool registration pattern follows existing conventions
  - [ ] Test tool factory registration with only 2 tools

- [ ] **Preserve Underlying Service Functionality** (AC: 4)
  - [ ] Verify HubService functionality remains intact
  - [ ] Ensure memory storage format (Kind "10", tags) remains unchanged
  - [ ] Preserve createMemoryTags() utility function
  - [ ] Maintain memory constants (MEMORY_KIND, MEMORY_TAGS)
  - [ ] Verify no regression in memory storage and retrieval capabilities

- [ ] **Update Tool Descriptions for MVP Focus** (AC: 5)
  - [ ] Update storeMemory tool description to emphasize core storage functionality
  - [ ] Update searchMemory tool description to emphasize core search functionality
  - [ ] Ensure descriptions align with 3-3-3 architecture goals
  - [ ] Update any documentation references to reflect simplified tool set

- [ ] **Testing and Validation**
  - [ ] Update existing unit tests for remaining memory tools
  - [ ] Remove test files for deleted memory tools
  - [ ] Verify all tests pass with simplified tool set
  - [ ] Test memory storage and retrieval functionality end-to-end
  - [ ] Verify no regression in core memory capabilities

- [ ] **Quality Assurance**
  - [ ] Run npm run build to ensure no build errors
  - [ ] Run npm run lint to verify code quality
  - [ ] Run npm run type-check to ensure TypeScript compliance
  - [ ] Run npm run test to verify all tests pass
  - [ ] Verify tool count reduction aligns with MVP goals

## Dev Notes

### Previous Story Insights

From Story 2.3 completion:

- Successfully embedded token NLS templates in server core
- Established patterns for tool simplification while maintaining functionality
- Demonstrated how to remove complex tools while preserving core capabilities
- Server architecture supports simplified tool registration patterns
- Comprehensive testing ensures no regression in core functionality

### Current Memory Tool Assessment

**Current State Analysis** [Source: Task tool analysis]:

The current memory tools already closely match the story requirements:

- **Existing Tools**: AddMemoryCommand (registered as "storeMemory"), SearchMemoriesCommand (registered as "searchMemory")
- **Complex Tools Status**: The 8 complex memory tools mentioned in the epic appear to have been removed or never existed
- **Tool Factory**: MemoryToolFactory already registers only the 2 essential tools
- **Naming**: Tools are already properly named "storeMemory" and "searchMemory"

### Data Models

**Memory Storage Model** [Source: HubService and memory constants]:

```typescript
interface MemoryRecord {
  kind: "10"; // MEMORY_KIND constant
  tags: {
    Content: string; // Memory content
    Kind: "10"; // Record type identifier
    p: string; // Party/public key
    r: string; // Role
  };
  data?: string; // Optional additional data
}
```

**Memory Tool Parameters** [Source: AddMemoryCommand and SearchMemoriesCommand]:

```typescript
// storeMemory parameters
interface AddMemoryArgs {
  content: string; // Memory content to store
  p: string; // Public key of the other party
  role: string; // Role of the author
}

// searchMemory parameters
interface SearchMemoriesArgs {
  search: string; // Keyword or content to search for
}
```

### API Specifications

**HubService Integration** [Source: HubService analysis]:

- `hubService.createEvent()` - Creates memory events with tags and optional data
- `hubService.search()` - Searches memories by value and kind with limit of 100
- Memory records use Kind "10" for identification
- Tag structure includes Content, Kind, Party (p), Role (r)

**Tool Registration Pattern** [Source: server.ts analysis]:

```typescript
// Two-phase registration pattern
const memoryFactory = new MemoryToolFactory({
  categoryDescription:
    "AI Memory management tools for persistent storage and retrieval",
  categoryName: "Memory",
  context: basicContext, // Basic then full context
});
memoryFactory.registerTools(toolRegistry);
```

### Component Specifications

**MemoryToolFactory Structure** [Source: MemoryToolFactory.ts]:

```typescript
export class MemoryToolFactory extends BaseToolFactory {
  protected getToolClasses(): Array<new (context: ToolContext) => ToolCommand> {
    return [AddMemoryCommand, SearchMemoriesCommand]; // Only 2 tools
  }
}
```

**Tool Command Structure** [Source: AddMemoryCommand and SearchMemoriesCommand]:

```typescript
export class AddMemoryCommand extends ToolCommand<AddMemoryArgs, string> {
  protected metadata: ToolMetadata = {
    description: "Store a memory in the AI memory system for later retrieval",
    name: "storeMemory",
    // ... other metadata
  };
}
```

### File Locations

**Files to Analyze/Modify**:

- Memory Commands: `src/tools/memory/commands/` directory
- Tool Factory: `src/tools/memory/MemoryToolFactory.ts`
- Memory Utilities: `src/tools/memory/utils.ts`
- Memory Constants: `src/tools/memory/constants.ts`

**Files to Test**:

- Memory Tests: `tests/unit/tools/memory/` directory
- Unit tests for remaining commands
- Integration tests for simplified tool set

**Files to Remove (if they exist)**:

- Any complex memory tool command files not in the current 2-tool set
- Associated test files for removed commands
- References in index.ts files

### Testing Requirements

**Testing Framework** [Source: Project configuration]:

- Uses Vitest for testing with TypeScript support
- Test location: `tests/unit/tools/memory/`
- Coverage target: 90% test coverage for remaining tools
- Mock HubService for isolated testing

**Test Scenarios Required**:

- Memory storage functionality with proper tag creation
- Memory search functionality with keyword matching
- Parameter validation for both tools
- Error handling for service failures
- Tool registration in simplified factory
- No regression in core memory capabilities

### Technical Constraints

**Dependencies** [Source: Project architecture]:

- Must maintain HubService integration patterns
- Must preserve memory storage format (Kind "10", tags)
- Must maintain existing server initialization patterns
- Must follow existing tool factory registration patterns
- Must not break existing memory storage and retrieval

**MVP Alignment** [Source: 3-3-3 Architecture]:

- Aligns with "3 MCP Tools" architecture goal
- Supports core memory functionality (storeMemory, searchMemory)
- Maintains essential user flows for memory interaction
- Reduces complexity while preserving functionality

### Project Structure Notes

**Current Structure Assessment**:

- Memory tools already follow the simplified pattern described in the epic
- Tool factory pattern supports the 2-tool registration requirement
- HubService provides all necessary backend functionality
- Testing infrastructure supports comprehensive coverage
- Server registration pattern accommodates simplified tool set

**No Structural Conflicts Found**:

- Current memory tool structure aligns with story requirements
- Tool factory pattern supports 2-tool registration
- HubService integration patterns are already established
- Testing infrastructure supports simplified tool coverage

**3-3-3 Architecture Alignment** [Source: docs/mvp/the-3-3-3-architecture.md]:

- Story supports the "3 MCP Tools" goal by focusing on core memory functions
- Aligns with "storeMemory" and "searchMemory" mentioned in the architecture
- Maintains essential memory functionality while reducing complexity
- Supports the MVP user flows for memory interaction

## Testing

### Testing Standards

**Test Framework**: Vitest with TypeScript support
**Test Location**: `tests/unit/tools/memory/`
**Coverage Target**: 90% test coverage for remaining memory tools
**Test Pattern**: Mock HubService, test core memory functionality

### Test Cases Required

**Memory Storage Tests**:

- Successful memory storage with proper tags
- Parameter validation for storeMemory
- Error handling for storage failures
- Memory tag creation verification

**Memory Search Tests**:

- Successful memory search with keyword matching
- Parameter validation for searchMemory
- Error handling for search failures
- Result formatting and return value validation

**Tool Factory Tests**:

- Tool registration with only 2 commands
- Category description and naming
- Context injection and initialization

**Integration Tests**:

- End-to-end memory storage and retrieval
- Tool registration in server initialization
- No regression in core memory capabilities

## Change Log

| Date       | Version | Description                                           | Author |
| ---------- | ------- | ----------------------------------------------------- | ------ |
| 2025-07-17 | 1.0     | Initial story creation for memory tool simplification | Claude |

## Dev Agent Record

_This section will be populated during development_

## QA Results

_This section will be populated during QA review_
