# Story 4.2: Claude Code File-Based Agent Detection

## Status

Pending

## Story

**As a** Claude Code user,
**I want** agents to automatically activate based on my commands and file operations,
**so that** I get contextual AI assistance that understands my current development focus and project state.

## Acceptance Criteria

1. Create CLI command pattern detection for agent activation
2. Implement file-based project structure with `.bmad/` directory for agent state
3. Enable git-aware context switching based on file operations and commit patterns
4. Support explicit agent activation via `--agent` command flags
5. Maintain persistent agent state across CLI sessions through file system
6. Integrate agent handoff protocols with memory transfer between sessions

## Tasks / Subtasks

- [ ] **Implement CLI Command Pattern Detection** (AC: 1)
  - [ ] Create command line argument parser for agent activation patterns
  - [ ] Define agent activation patterns based on development tasks
  - [ ] Add pattern matching for common development workflows
  - [ ] Implement context detection from command parameters
  - [ ] Support natural language command interpretation
  - [ ] Add fallback patterns for unknown commands

- [ ] **Create File-Based Project Structure** (AC: 2)
  - [ ] Design `.bmad/` directory structure for agent state persistence
  - [ ] Implement agent state storage and retrieval
  - [ ] Create project configuration files for agent preferences
  - [ ] Add agent activity logging and session management
  - [ ] Support multiple project configurations
  - [ ] Implement state cleanup and maintenance

- [ ] **Enable Git-Aware Context Switching** (AC: 3)
  - [ ] Implement git repository detection and analysis
  - [ ] Create context switching based on file changes
  - [ ] Add commit pattern analysis for agent activation
  - [ ] Support branch-based agent configuration
  - [ ] Implement file operation monitoring
  - [ ] Add project stage detection (development, testing, deployment)

- [ ] **Support Explicit Agent Activation** (AC: 4)
  - [ ] Implement `--agent` command flag parsing
  - [ ] Create agent selection interface
  - [ ] Support agent role specification (PM, Dev, UX, QA)
  - [ ] Add agent capability verification
  - [ ] Implement agent handoff commands
  - [ ] Support agent session management

- [ ] **Maintain Persistent Agent State** (AC: 5)
  - [ ] Implement file-based agent state persistence
  - [ ] Create session state management across CLI invocations
  - [ ] Add agent memory persistence between sessions
  - [ ] Support agent configuration inheritance
  - [ ] Implement state synchronization across sessions
  - [ ] Add state corruption detection and recovery

- [ ] **Integrate Agent Handoff Protocols** (AC: 6)
  - [ ] Create agent-to-agent communication protocols
  - [ ] Implement memory transfer between agent sessions
  - [ ] Support context preservation during handoffs
  - [ ] Add agent collaboration tracking
  - [ ] Implement handoff validation and confirmation
  - [ ] Support multi-agent workflow coordination

- [ ] **Testing and Validation**
  - [ ] Create unit tests for command pattern detection
  - [ ] Test file-based state persistence
  - [ ] Validate git-aware context switching
  - [ ] Test explicit agent activation flows
  - [ ] Verify agent handoff protocols
  - [ ] Test cross-session state management

- [ ] **Quality Assurance**
  - [ ] Validate CLI integration compatibility
  - [ ] Test file system permission handling
  - [ ] Verify git integration robustness
  - [ ] Test agent state consistency
  - [ ] Validate memory transfer protocols
  - [ ] Ensure backward compatibility

## Dev Notes

### Previous Story Insights

From Story 4.1 (Claude Desktop Conversation-Based Agent Teams) completion:

- Successfully implemented conversation name detection for automatic agent activation
- Established patterns for agent role mapping and context sharing
- Created project-based organization with conversation structure
- Demonstrated cross-conversation context sharing through Permamind memory
- Built foundation for multi-platform agent coordination

### Claude Code Agent Detection Requirements

**Story 4.2 Overview** [Source: Epic 4 Agent UX Enhancement]:

This story implements file-based agent detection for Claude Code environment:

- **CLI Pattern Detection**: Automatic agent activation based on command patterns
- **File-Based Structure**: `.bmad/` directory for persistent agent state
- **Git Integration**: Context switching based on git operations and file changes
- **Explicit Activation**: `--agent` flags for direct agent selection
- **State Persistence**: Cross-session agent state management
- **Handoff Protocols**: Agent-to-agent memory transfer and coordination

### Data Models

**CLI Agent Detection Models** [Source: Claude Code integration requirements]:

```typescript
interface CLIAgentPattern {
  pattern: RegExp;
  agentRole: AgentRole;
  confidence: number;
  contextHints: string[];
  requiredFiles?: string[];
  excludePatterns?: RegExp[];
}

interface AgentActivationContext {
  command: string;
  arguments: string[];
  workingDirectory: string;
  gitContext: GitContext;
  fileOperations: FileOperation[];
  sessionId: string;
  timestamp: Date;
}

interface GitContext {
  repository: string;
  branch: string;
  lastCommit: string;
  modifiedFiles: string[];
  stagedFiles: string[];
  status: GitStatus;
}
```

**File-Based Agent State Models** [Source: Agent state persistence requirements]:

```typescript
interface AgentState {
  agentId: string;
  role: AgentRole;
  sessionId: string;
  context: AgentContext;
  memory: AgentMemory[];
  configuration: AgentConfiguration;
  lastActivity: Date;
  status: "active" | "idle" | "handoff" | "completed";
}

interface AgentConfiguration {
  projectPath: string;
  preferences: AgentPreferences;
  capabilities: string[];
  collaborators: string[];
  workflows: WorkflowDefinition[];
  handoffRules: HandoffRule[];
}

interface HandoffRule {
  fromAgent: string;
  toAgent: string;
  triggers: string[];
  memoryTransfer: MemoryTransferRule[];
  validation: HandoffValidation;
}
```

**Agent Memory Transfer Models** [Source: Memory integration requirements]:

```typescript
interface MemoryTransferProtocol {
  sessionId: string;
  fromAgent: string;
  toAgent: string;
  memories: TransferableMemory[];
  context: TransferContext;
  validation: TransferValidation;
}

interface TransferableMemory {
  memoryId: string;
  content: string;
  type: MemoryType;
  importance: number;
  transferReason: string;
  sharedWith: string[];
}

interface TransferContext {
  projectState: ProjectState;
  currentTask: string;
  nextSteps: string[];
  blockers: string[];
  handoffReason: string;
}
```

### API Specifications

**CLI Pattern Detection Integration** [Source: Claude Code CLI patterns]:

- `detectAgentPattern(command: string, args: string[])` - Detect appropriate agent from CLI input
- `analyzeCommandContext(context: CLIContext)` - Analyze command context for agent selection
- `validateAgentCapabilities(agent: string, task: string)` - Validate agent can handle task
- `generateAgentActivation(pattern: CLIAgentPattern)` - Generate agent activation command
- `parseExplicitAgentFlag(args: string[])` - Parse --agent flag from command line
- `integrateWithCLIFramework(framework: CLIFramework)` - Integrate with Claude Code CLI

**File-Based State Management** [Source: File system integration]:

- `initializeProjectStructure(projectPath: string)` - Initialize .bmad/ directory structure
- `saveAgentState(agentId: string, state: AgentState)` - Persist agent state to file system
- `loadAgentState(agentId: string)` - Load agent state from file system
- `synchronizeAgentStates(projectPath: string)` - Synchronize states across sessions
- `cleanupOrphanedStates(projectPath: string)` - Clean up abandoned agent sessions
- `validateStateIntegrity(statePath: string)` - Validate agent state file integrity

**Git Integration Service** [Source: Git-aware context switching]:

- `detectGitRepository(path: string)` - Detect git repository in project
- `analyzeGitContext(repoPath: string)` - Analyze current git state for context
- `monitorFileOperations(path: string)` - Monitor file operations for context changes
- `detectCommitPatterns(commits: GitCommit[])` - Detect patterns in commit history
- `switchContextOnBranch(branch: string)` - Switch agent context based on branch
- `integrateWithGitHooks(repoPath: string)` - Integrate with git hooks for automatic detection

### Component Specifications

**CLIAgentDetectionService Structure** [Source: CLI integration patterns]:

```typescript
export class CLIAgentDetectionService {
  constructor(
    private memoryService: AIMemoryService,
    private stateService: AgentStateService,
    private gitService: GitIntegrationService,
  ) {}

  async detectAgent(
    command: string,
    args: string[],
    context: CLIContext,
  ): Promise<AgentActivationResult> {
    // Analyze CLI input and context to determine appropriate agent
    // Integrate with git context and file operations
  }

  async activateAgent(
    agentRole: AgentRole,
    context: AgentActivationContext,
  ): Promise<AgentSession> {
    // Activate agent with appropriate context and state
    // Initialize agent session with persistent state
  }
}
```

**AgentStateService Structure** [Source: State persistence patterns]:

```typescript
export class AgentStateService {
  constructor(
    private fileSystemService: FileSystemService,
    private memoryService: AIMemoryService,
  ) {}

  async initializeProject(projectPath: string): Promise<ProjectStructure> {
    // Initialize .bmad/ directory structure for agent state
    // Set up configuration and state management
  }

  async persistAgentState(
    agentId: string,
    state: AgentState,
  ): Promise<void> {
    // Persist agent state to file system
    // Maintain state consistency across sessions
  }

  async transferAgentMemory(
    fromAgent: string,
    toAgent: string,
    protocol: MemoryTransferProtocol,
  ): Promise<TransferResult> {
    // Transfer memory between agents during handoffs
    // Validate transfer and update agent states
  }
}
```

**GitIntegrationService Structure** [Source: Git integration patterns]:

```typescript
export class GitIntegrationService {
  constructor(
    private agentDetection: CLIAgentDetectionService,
    private stateService: AgentStateService,
  ) {}

  async analyzeGitContext(repoPath: string): Promise<GitContext> {
    // Analyze git repository state for context switching
    // Detect file operations and commit patterns
  }

  async monitorRepositoryChanges(
    repoPath: string,
    callback: (context: GitContext) => void,
  ): Promise<void> {
    // Monitor git repository for changes that trigger agent activation
    // Integrate with file system watchers
  }
}
```

### File Locations

**Files to Create**:

- CLI Detection: `src/services/CLIAgentDetectionService.ts`
- State Management: `src/services/AgentStateService.ts`
- Git Integration: `src/services/GitIntegrationService.ts`
- Agent Models: `src/models/CLIAgent.ts`, `src/models/AgentState.ts`
- CLI Tools: `src/tools/cli/` directory for Claude Code integration
- Project Structure: Templates for `.bmad/` directory initialization

**Files to Modify**:

- Service Exports: `src/services/index.ts` (add CLI agent services)
- Model Exports: `src/models/index.ts` (add CLI agent models)
- CLI Integration: Claude Code CLI framework integration

**Files to Test**:

- CLI Agent Tests: `tests/unit/services/` directory for service tests
- Integration Tests: `tests/integration/` directory for CLI workflow tests
- Git Integration Tests: `tests/unit/services/GitIntegrationService.unit.test.ts`

### Testing Requirements

**Testing Framework** [Source: Claude Code testing patterns]:

- Uses Vitest for testing with TypeScript support
- Test location: `tests/unit/services/` and `tests/integration/`
- Coverage target: 90% functions, 85% lines, 75% branches
- Mock Strategy: CLI framework and file system mocking

**Test Scenarios Required**:

- CLI command pattern detection and agent activation
- File-based state persistence and recovery
- Git-aware context switching and monitoring
- Explicit agent activation via command flags
- Agent handoff protocols and memory transfer
- Cross-session state consistency

### Technical Constraints

**Dependencies** [Source: Claude Code integration requirements]:

- Must integrate with Claude Code CLI framework
- Must use file system APIs for state persistence
- Must integrate with git command line tools
- Must maintain compatibility with existing agent system
- Must follow Claude Code extension patterns
- Must support cross-platform file operations

**CLI Integration Requirements** [Source: Claude Code architecture]:

- Must work with existing Claude Code command structure
- Must maintain CLI performance and responsiveness
- Must handle file system permissions appropriately
- Must integrate with existing Claude Code authentication
- Must support Claude Code workspace management
- Must preserve existing Claude Code functionality

### Project Structure Notes

**Current Structure Assessment**:

- Existing agent system provides foundation for CLI integration
- Current memory services support agent state persistence
- Tool factory patterns can accommodate CLI agent tools
- Service architecture supports adding CLI detection services
- Testing infrastructure supports CLI integration testing

**CLI Agent Integration Alignment**:

- Service layer can accommodate CLI detection services
- Existing memory system supports agent state persistence
- Current agent architecture supports file-based state management
- Git integration can extend existing file operation patterns
- CLI tools can integrate with existing tool factory system

**No Structural Conflicts Expected**:

- CLI agent services will extend existing agent patterns
- File-based state will complement existing memory services
- Git integration will extend existing file operation capabilities
- Agent handoff will use existing memory transfer protocols
- CLI integration will follow established extension patterns

## Testing

### Testing Standards

**Test Framework**: Vitest with TypeScript support
**Test Location**: `tests/unit/services/` and `tests/integration/`
**Coverage Target**: 90% functions, 85% lines, 75% branches
**Test Pattern**: Mock CLI framework and file system, test agent detection and state management

### Test Cases Required

**CLI Agent Detection Tests**:

- Command pattern recognition and agent selection
- Context analysis and agent capability matching
- Explicit agent flag parsing and validation
- Git context integration and pattern detection
- File operation monitoring and context switching

**Agent State Management Tests**:

- File-based state persistence and recovery
- Cross-session state consistency
- Project structure initialization
- State synchronization and cleanup
- State corruption detection and recovery

**Git Integration Tests**:

- Git repository detection and analysis
- File operation monitoring and context switching
- Commit pattern analysis and agent activation
- Branch-based context switching
- Git hook integration and automation

**Agent Handoff Tests**:

- Agent-to-agent memory transfer protocols
- Handoff validation and confirmation
- Context preservation during handoffs
- Multi-agent workflow coordination
- Handoff rollback and recovery

## Change Log

| Date       | Version | Description                                           | Author |
| ---------- | ------- | ----------------------------------------------------- | ------ |
| 2025-07-19 | 1.0     | Initial story creation for Claude Code agent detection | Claude |

## Dev Agent Record

### Agent Model Used

_This section will be populated during development_

### Debug Log References

_To be filled during implementation_

### Completion Notes List

_To be filled during implementation_

### File List

**Files to Create:**

_To be populated during development_

**Files to Modify:**

_To be populated during development_

## QA Results

### Review Date

_To be filled during QA review_

### Reviewed By

_To be filled during QA review_

### Code Quality Assessment

_To be filled during QA review_

### Final Status

_To be determined during QA review_