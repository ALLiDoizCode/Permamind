# Story 5.1: Implement createProcess MCP Tool

## Status

Pending

## Story

**As a** developer using Permamind,
**I want** to spawn new AO processes through an MCP command,
**so that** I can create dedicated computational environments for my applications without manual AO setup.

## Acceptance Criteria

1. Create CreateProcessCommand following existing ProcessToolFactory patterns
2. Integrate with existing createProcess() function from process.ts:60
3. Use established signer management from current MCP tool infrastructure
4. Return processId upon successful creation with 3-second initialization delay
5. Include proper error handling and validation for process creation failures
6. Provide clear tool description and parameter documentation for AI understanding
7. Maintain compatibility with existing AO Connect configuration (SCHEDULER, AOS_MODULE)

## Tasks / Subtasks

- [ ] **Create CreateProcessCommand class** (AC: 1)
  - [ ] Create new CreateProcessCommand class extending ToolCommand
  - [ ] Implement tool metadata with description for creating AO processes
  - [ ] Define parameter schema using Zod (no parameters required for basic process creation)
  - [ ] Follow existing ExecuteProcessActionCommand pattern for consistency
  - [ ] Use proper TypeScript interfaces and error handling patterns

- [ ] **Integrate with existing createProcess function** (AC: 2)
  - [ ] Import createProcess function from process.ts:60
  - [ ] Use existing function signature: createProcess(signer: JWKInterface)
  - [ ] Maintain compatibility with existing AO Connect patterns
  - [ ] Preserve existing error handling and timeout patterns
  - [ ] Use established AOS_MODULE() and SCHEDULER() configuration

- [ ] **Implement signer management integration** (AC: 3)
  - [ ] Use this.context.keyPair for signer access following existing patterns
  - [ ] Ensure proper JWKInterface type compatibility
  - [ ] Follow established authentication patterns from other process tools
  - [ ] Maintain consistency with ExecuteProcessActionCommand signer usage
  - [ ] Handle signer validation and error cases appropriately

- [ ] **Implement process creation with proper response** (AC: 4)
  - [ ] Call createProcess() function with proper signer
  - [ ] Include 3-second initialization delay after process creation
  - [ ] Return processId in structured JSON response format
  - [ ] Include success status and descriptive message
  - [ ] Provide clear response format for AI understanding

- [ ] **Add comprehensive error handling** (AC: 5)
  - [ ] Catch and handle process creation failures gracefully
  - [ ] Provide meaningful error messages for different failure scenarios
  - [ ] Handle timeout errors and network connectivity issues
  - [ ] Return structured error responses in JSON format
  - [ ] Follow existing error handling patterns from other process tools

- [ ] **Create tool documentation and metadata** (AC: 6)
  - [ ] Write clear tool description for AI understanding
  - [ ] Include examples of process creation usage
  - [ ] Document expected response format and error conditions
  - [ ] Provide parameter documentation (none required for basic creation)
  - [ ] Follow existing tool metadata patterns for consistency

- [ ] **Ensure AO Connect compatibility** (AC: 7)
  - [ ] Use existing SCHEDULER() configuration from constants
  - [ ] Use existing AOS_MODULE() configuration from constants
  - [ ] Maintain compatibility with current @permaweb/aoconnect version
  - [ ] Preserve existing spawn() function usage patterns
  - [ ] Ensure compatibility with existing process communication infrastructure

- [ ] **Register tool with ProcessToolFactory** (AC: 1)
  - [ ] Add CreateProcessCommand to ProcessToolFactory.ts registration array
  - [ ] Update src/tools/process/commands/index.ts exports
  - [ ] Ensure proper tool context injection for keyPair access
  - [ ] Test tool integration with FastMCP framework
  - [ ] Verify tool appears in MCP tool registry

- [ ] **Unit testing for CreateProcessCommand**
  - [ ] Create comprehensive unit tests for CreateProcessCommand
  - [ ] Test successful process creation scenario
  - [ ] Test error handling for process creation failures
  - [ ] Test timeout and network error scenarios
  - [ ] Test tool context integration and signer access
  - [ ] Mock createProcess function for isolated testing
  - [ ] Ensure tests achieve target coverage for new functionality

## Dev Notes

### Previous Story Insights

From Epic 5 Process Management Tools requirements:

- Epic 5 focuses on expanding AO process lifecycle management capabilities
- Leverages existing createProcess() and evalProcess() functions from process.ts and relay.ts
- Integrates with established ProcessToolFactory patterns
- Uses current MCP tool infrastructure and signer management
- Supports foundational AO development workflow requirements

### Data Models

**CreateProcess Tool Parameters** [Source: process.ts createProcess function analysis]:

```typescript
// No parameters required - uses signer from tool context
interface CreateProcessArgs {
  // Empty interface - process creation uses default AOS configuration
}
```

**Process Creation Response Structure** [Source: MCP tool response patterns]:

```typescript
interface CreateProcessResponse {
  success: boolean;
  processId?: string;
  message: string;
  error?: string;
}
```

### API Specifications

**Process Creation Integration** [Source: src/process.ts:60-75]:

- Uses `spawn({ module, scheduler, signer, tags })` from @permaweb/aoconnect
- Module: `AOS_MODULE()` from constants for standard AO process
- Scheduler: `SCHEDULER()` from constants for process execution
- Signer: `this.context.keyPair` from MCP tool context
- Tags: Optional additional metadata for process identification

**Tool Context Integration** [Source: ProcessToolFactory patterns]:

```typescript
interface ToolContext {
  keyPair: JWKInterface;
  hubId: string;
  publicKey: string;
}
```

**Error Handling Pattern** [Source: Existing process tools]:

```typescript
try {
  const processId = await createProcess(this.context.keyPair);
  // 3-second initialization delay
  await new Promise((resolve) => setTimeout(resolve, 3000));
  return JSON.stringify({
    success: true,
    processId,
    message: `AO process created successfully: ${processId}`,
  });
} catch (error) {
  return JSON.stringify({
    success: false,
    error: error instanceof Error ? error.message : "Unknown error",
    message: "Failed to create AO process",
  });
}
```

### Component Specifications

**CreateProcessCommand Structure** [Source: Tool command patterns]:

```typescript
export class CreateProcessCommand extends ToolCommand<
  CreateProcessArgs,
  string
> {
  protected metadata: ToolMetadata = {
    description: "Create a new AO process and return its process ID",
    name: "createProcess",
    openWorldHint: false,
    readOnlyHint: false,
    title: "Create AO Process",
  };

  protected parametersSchema = z.object({
    // No parameters required for basic process creation
  });

  async execute(args: CreateProcessArgs): Promise<string> {
    // Implementation using existing createProcess function
  }
}
```

### File Locations

**Files to Create**:

- Command Implementation: `src/tools/process/commands/CreateProcessCommand.ts`
- Unit Tests: `tests/unit/tools/process/CreateProcessCommand.unit.test.ts`

**Files to Modify**:

- Tool Factory: `src/tools/process/ProcessToolFactory.ts` (add CreateProcessCommand)
- Exports: `src/tools/process/commands/index.ts` (add CreateProcessCommand export)

**Reference Files**:

- Pattern Reference: `src/tools/process/commands/ExecuteProcessActionCommand.ts`
- Process Function: `src/process.ts` (createProcess function at line 60)
- Test Pattern: `tests/unit/tools/process/ExecuteProcessActionCommand.unit.test.ts`

### Testing Requirements

**Testing Framework**: Vitest with TypeScript support
**Test Location**: `tests/unit/tools/process/`
**Coverage Target**: 90% test coverage for new functionality
**Mock Strategy**: Mock createProcess function and AO Connect dependencies

**Test Scenarios Required**:

- Successful process creation with valid signer
- Error handling for process creation failures
- Timeout handling and network connectivity issues
- Tool context integration and signer validation
- Response format validation for success and error cases
- Integration with ProcessToolFactory registration

### Technical Constraints

**Dependencies**:

- Must use existing createProcess() function from process.ts:60
- Must maintain compatibility with current @permaweb/aoconnect version
- Must follow FastMCP tool registration conventions
- Must use established signer management patterns
- Must preserve existing AO Connect configuration patterns

**AO Integration Requirements**:

- Must use AOS_MODULE() for standard AO process creation
- Must use SCHEDULER() for process execution scheduling
- Must maintain compatibility with existing process communication infrastructure
- Must follow established process ID format and validation patterns
- Must preserve existing error handling and timeout patterns

### Project Structure Notes

**Current Structure Assessment**:

- Existing ProcessToolFactory provides foundation for new process tools
- Current process.ts module contains required createProcess function
- Tool registration patterns support adding new process management tools
- Testing infrastructure supports comprehensive process tool coverage
- MCP server architecture accommodates process management tool expansion

**Process Management Integration Alignment**:

- Service layer can accommodate new process creation tools
- Existing AO Connect integration supports process spawning workflow
- Current tool factory patterns support adding CreateProcessCommand
- Process communication infrastructure supports expanded process lifecycle
- Error handling patterns are consistent with existing process tools

**No Structural Conflicts Expected**:

- CreateProcessCommand will extend existing ProcessToolFactory patterns
- Process creation will integrate with existing AO Connect configuration
- Tool registration will follow established MCP registration patterns
- Error handling will use existing process tool error patterns
- Testing will extend existing process tool testing infrastructure

## Testing

### Testing Standards

**Test Framework**: Vitest with TypeScript support
**Test Location**: `tests/unit/tools/process/`
**Coverage Target**: 90% test coverage for new functionality
**Test Pattern**: Mock createProcess function and AO dependencies, test tool execution

### Test Cases Required

**CreateProcessCommand Tests**:

- Successful process creation with proper processId return
- Error handling for process creation failures
- Timeout and network connectivity error scenarios
- Tool context integration and signer validation
- Response format validation for success and error cases
- Integration with ProcessToolFactory registration patterns

## Change Log

| Date       | Version | Description                                       | Author |
| ---------- | ------- | ------------------------------------------------- | ------ |
| 2025-07-19 | 1.0     | Initial story creation for createProcess MCP tool | Claude |

## Dev Agent Record

### Agent Model Used

_This section will be populated during development_

### Debug Log References

_To be filled during implementation_

### Completion Notes List

_To be filled during implementation_

### File List

**Files to Create:**

_To be populated during development_

**Files to Modify:**

_To be populated during development_

## QA Results

### Review Date

_To be filled during QA review_

### Reviewed By

_To be filled during QA review_

### Code Quality Assessment

_To be filled during QA review_

### Final Status

_To be determined during QA review_
