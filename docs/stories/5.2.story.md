# Story 5.2: Implement evalProcess MCP Tool

## Status

Pending

## Story

**As a** developer working with AO processes,
**I want** to evaluate Lua code within existing processes through an MCP command,
**so that** I can test functionality, debug issues, and execute operations programmatically.

## Acceptance Criteria

1. Create EvalProcessCommand following existing ProcessToolFactory patterns
2. Integrate with existing evalProcess() function from relay.ts:41-52
3. Accept processId and Lua code as parameters with proper validation
4. Use established signer management and error handling patterns
5. Handle evaluation errors gracefully with meaningful error messages
6. Support both simple expressions and complex multi-line Lua code blocks
7. Maintain silent error handling consistent with existing relay.ts patterns
8. Include comprehensive tool description for AI-assisted usage

## Tasks / Subtasks

- [ ] **Create EvalProcessCommand class** (AC: 1)
  - [ ] Create new EvalProcessCommand class extending ToolCommand
  - [ ] Implement tool metadata with description for evaluating Lua code in AO processes
  - [ ] Define parameter schema using Zod for processId and code validation
  - [ ] Follow existing ExecuteProcessActionCommand pattern for consistency
  - [ ] Use proper TypeScript interfaces and error handling patterns

- [ ] **Integrate with existing evalProcess function** (AC: 2)
  - [ ] Import evalProcess function from relay.ts:41-52
  - [ ] Use existing function signature: evalProcess(signer, data, processId)
  - [ ] Maintain compatibility with existing AO Connect message patterns
  - [ ] Preserve existing silent error handling approach
  - [ ] Use established message sending and result processing patterns

- [ ] **Implement parameter validation** (AC: 3)
  - [ ] Validate processId using CommonSchemas.processId pattern
  - [ ] Validate Lua code as non-empty string with reasonable length limits
  - [ ] Support multi-line code blocks with proper string handling
  - [ ] Include parameter descriptions for AI understanding
  - [ ] Handle special characters and code formatting appropriately

- [ ] **Implement signer management integration** (AC: 4)
  - [ ] Use this.context.keyPair for signer access following existing patterns
  - [ ] Ensure proper JWKInterface type compatibility with evalProcess function
  - [ ] Follow established authentication patterns from other process tools
  - [ ] Maintain consistency with existing process communication tools
  - [ ] Handle signer validation and error cases appropriately

- [ ] **Add comprehensive error handling** (AC: 5)
  - [ ] Catch and handle Lua evaluation errors gracefully
  - [ ] Provide meaningful error messages for different failure scenarios
  - [ ] Handle timeout errors and network connectivity issues
  - [ ] Return structured error responses in JSON format
  - [ ] Follow existing error handling patterns from relay.ts (silent failures)

- [ ] **Support various Lua code formats** (AC: 6)
  - [ ] Handle simple Lua expressions (e.g., "2 + 2")
  - [ ] Support complex multi-line Lua code blocks
  - [ ] Handle Lua function definitions and variable assignments
  - [ ] Support AO-specific Lua patterns and message handling
  - [ ] Preserve code formatting and handle escape characters properly

- [ ] **Maintain silent error handling consistency** (AC: 7)
  - [ ] Follow existing relay.ts:52 pattern for silent error handling
  - [ ] Return null or appropriate response for evaluation failures
  - [ ] Avoid throwing exceptions for expected evaluation failures
  - [ ] Maintain consistency with existing AO message processing patterns
  - [ ] Handle timeout scenarios gracefully without stack traces

- [ ] **Create comprehensive tool documentation** (AC: 8)
  - [ ] Write clear tool description for AI understanding
  - [ ] Include examples of Lua code evaluation usage
  - [ ] Document expected response format and error conditions
  - [ ] Provide parameter documentation for processId and code
  - [ ] Include best practices for AO Lua code evaluation

- [ ] **Register tool with ProcessToolFactory** (AC: 1)
  - [ ] Add EvalProcessCommand to ProcessToolFactory.ts registration array
  - [ ] Update src/tools/process/commands/index.ts exports
  - [ ] Ensure proper tool context injection for keyPair access
  - [ ] Test tool integration with FastMCP framework
  - [ ] Verify tool appears in MCP tool registry

- [ ] **Unit testing for EvalProcessCommand**
  - [ ] Create comprehensive unit tests for EvalProcessCommand
  - [ ] Test successful Lua code evaluation scenarios
  - [ ] Test error handling for invalid processId and code
  - [ ] Test timeout and network error scenarios
  - [ ] Test various Lua code formats (simple expressions, multi-line blocks)
  - [ ] Mock evalProcess function for isolated testing
  - [ ] Ensure tests achieve target coverage for new functionality

## Dev Notes

### Previous Story Insights

From Story 5.1 (CreateProcess MCP Tool) patterns:

- ProcessToolFactory integration patterns established
- Tool context and signer management approach defined
- Error handling and response format patterns confirmed
- MCP tool registration and testing patterns available
- AO Connect integration patterns proven

### Data Models

**EvalProcess Tool Parameters** [Source: relay.ts evalProcess function analysis]:

```typescript
interface EvalProcessArgs {
  processId: string; // AO process ID (43-character base64)
  code: string; // Lua code to evaluate in the process
}
```

**Process Evaluation Response Structure** [Source: MCP tool response patterns]:

```typescript
interface EvalProcessResponse {
  success: boolean;
  result?: any; // Evaluation result from AO process
  message: string;
  error?: string;
}
```

### API Specifications

**Process Evaluation Integration** [Source: src/relay.ts:41-52]:

```typescript
export const evalProcess = async (
  signer: JWKInterface,
  data: string,
  processId: string,
): Promise<any> => {
  try {
    return await send({
      processId,
      data,
      signer: createDataItemSigner(signer),
      tags: [{ name: "Action", value: "Eval" }],
    });
  } catch {
    // Silent error handling - return null on failure
    return null;
  }
};
```

**Tool Context Integration** [Source: ProcessToolFactory patterns]:

```typescript
interface ToolContext {
  keyPair: JWKInterface;
  hubId: string;
  publicKey: string;
}
```

**Parameter Validation Schema** [Source: Zod validation patterns]:

```typescript
protected parametersSchema = z.object({
  processId: CommonSchemas.processId,
  code: z
    .string()
    .min(1, "Lua code cannot be empty")
    .max(10000, "Lua code too long")
    .describe("Lua code to evaluate in the AO process"),
});
```

### Component Specifications

**EvalProcessCommand Structure** [Source: Tool command patterns]:

```typescript
export class EvalProcessCommand extends ToolCommand<
  EvalProcessArgs,
  string
> {
  protected metadata: ToolMetadata = {
    description: "Evaluate Lua code within an existing AO process",
    name: "evalProcess",
    openWorldHint: false,
    readOnlyHint: false,
    title: "Evaluate Process Code",
  };

  protected parametersSchema = z.object({
    processId: CommonSchemas.processId,
    code: z.string().min(1).max(10000).describe("Lua code to evaluate"),
  });

  async execute(args: EvalProcessArgs): Promise<string> {
    try {
      const result = await evalProcess(
        this.context.keyPair,
        args.code,
        args.processId,
      );
      
      if (result === null) {
        return JSON.stringify({
          success: false,
          message: "Code evaluation failed or timed out",
          error: "Evaluation returned null result",
        });
      }

      return JSON.stringify({
        success: true,
        result,
        message: "Code evaluated successfully",
      });
    } catch (error) {
      return JSON.stringify({
        success: false,
        error: error instanceof Error ? error.message : "Unknown error",
        message: "Failed to evaluate code in AO process",
      });
    }
  }
}
```

### File Locations

**Files to Create**:

- Command Implementation: `src/tools/process/commands/EvalProcessCommand.ts`
- Unit Tests: `tests/unit/tools/process/EvalProcessCommand.unit.test.ts`

**Files to Modify**:

- Tool Factory: `src/tools/process/ProcessToolFactory.ts` (add EvalProcessCommand)
- Exports: `src/tools/process/commands/index.ts` (add EvalProcessCommand export)

**Reference Files**:

- Pattern Reference: `src/tools/process/commands/ExecuteProcessActionCommand.ts`
- Eval Function: `src/relay.ts` (evalProcess function at lines 41-52)
- Test Pattern: `tests/unit/tools/process/ExecuteProcessActionCommand.unit.test.ts`

### Testing Requirements

**Testing Framework**: Vitest with TypeScript support
**Test Location**: `tests/unit/tools/process/`
**Coverage Target**: 90% test coverage for new functionality
**Mock Strategy**: Mock evalProcess function and AO Connect dependencies

**Test Scenarios Required**:

- Successful Lua code evaluation with various code formats
- Error handling for invalid processId and malformed code
- Silent error handling when evalProcess returns null
- Parameter validation for processId and code length/format
- Response format validation for success and error cases
- Integration with ProcessToolFactory registration

### Technical Constraints

**Dependencies**:

- Must use existing evalProcess() function from relay.ts:41-52
- Must maintain compatibility with current @permaweb/aoconnect version
- Must follow FastMCP tool registration conventions
- Must use established signer management patterns
- Must preserve silent error handling approach from relay.ts

**AO Integration Requirements**:

- Must use established AO message sending patterns
- Must maintain compatibility with existing process communication infrastructure
- Must follow AO Eval action tag conventions
- Must handle AO-specific Lua code evaluation patterns
- Must preserve existing timeout and error handling behavior

### Project Structure Notes

**Current Structure Assessment**:

- Existing ProcessToolFactory provides foundation for evalProcess tool
- Current relay.ts module contains required evalProcess function
- Tool registration patterns support adding new process management tools
- Testing infrastructure supports comprehensive process tool coverage
- MCP server architecture accommodates process evaluation tool expansion

**Process Evaluation Integration Alignment**:

- Service layer can accommodate new process evaluation tools
- Existing AO Connect integration supports code evaluation workflow
- Current tool factory patterns support adding EvalProcessCommand
- Process communication infrastructure supports expanded evaluation capabilities
- Error handling patterns are consistent with existing relay.ts patterns

**No Structural Conflicts Expected**:

- EvalProcessCommand will extend existing ProcessToolFactory patterns
- Code evaluation will integrate with existing AO Connect configuration
- Tool registration will follow established MCP registration patterns
- Error handling will use existing relay.ts silent error patterns
- Testing will extend existing process tool testing infrastructure

## Testing

### Testing Standards

**Test Framework**: Vitest with TypeScript support
**Test Location**: `tests/unit/tools/process/`
**Coverage Target**: 90% test coverage for new functionality
**Test Pattern**: Mock evalProcess function and AO dependencies, test tool execution

### Test Cases Required

**EvalProcessCommand Tests**:

- Successful Lua code evaluation with simple expressions
- Successful evaluation with complex multi-line code blocks
- Error handling for invalid processId format
- Error handling for empty or malformed Lua code
- Silent error handling when evalProcess returns null
- Parameter validation for code length limits
- Response format validation for success and error cases
- Integration with ProcessToolFactory registration patterns

## Change Log

| Date       | Version | Description                                    | Author |
| ---------- | ------- | ---------------------------------------------- | ------ |
| 2025-07-19 | 1.0     | Initial story creation for evalProcess MCP tool | Claude |

## Dev Agent Record

### Agent Model Used

_This section will be populated during development_

### Debug Log References

_To be filled during implementation_

### Completion Notes List

_To be filled during implementation_

### File List

**Files to Create:**

_To be populated during development_

**Files to Modify:**

_To be populated during development_

## QA Results

### Review Date

_To be filled during QA review_

### Reviewed By

_To be filled during QA review_

### Code Quality Assessment

_To be filled during QA review_

### Final Status

_To be determined during QA review_