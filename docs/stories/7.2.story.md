# Story 7.2: Implement Guided Lua Process Creation and Deployment Workflow

## Status

Done

## Story

**As a** user working with an AI agent, **I want** to describe what kind of AO process I need in natural language and have the system automatically generate, deploy, and test the appropriate Lua implementation using existing tools, **so that** I can efficiently create functional AO processes without manual coding or deployment steps.

## Acceptance Criteria

1. Integrate createProcess tool with documentation-informed Lua generation from Story 7.1
2. Implement end-to-end workflow: requirement analysis → documentation query → code generation → process creation → code evaluation → testing
3. Generate proper Lua process structure with handlers following AO documentation patterns (Handlers.add with name, match, handle functions)
4. Provide process templates for common use cases informed by existing AO tutorials (tokens, chatrooms, bots, games)
5. Include automatic validation using evalProcess to test generated handlers before final deployment
6. Enable iterative refinement: test → analyze results → query additional documentation → refine code → re-test
7. Support deployment verification through message testing and state inspection

## Tasks / Subtasks

- [ ] **Integrate Story 7.1 Components with Process Creation** (AC: 1)
  - [ ] Create `GuidedProcessCreationService` that integrates `LuaWorkflowOrchestrationService` with `CreateProcessCommand`
  - [ ] Implement workflow coordination between documentation-informed generation and process spawning
  - [ ] Add process creation context management to maintain state across workflow steps
  - [ ] Create unit tests for guided process creation integration using Vitest framework

- [ ] **Implement End-to-End Workflow Orchestration** (AC: 2)
  - [ ] Create `ProcessDeploymentWorkflowService` orchestrating the complete pipeline
  - [ ] Implement workflow state management for multi-step process creation
  - [ ] Add workflow progress tracking and error recovery mechanisms
  - [ ] Create integration tests for complete end-to-end workflow execution

- [ ] **Generate Proper Lua Process Structure** (AC: 3)
  - [ ] Extend `LuaCodeGeneratorService` with complete process structure templates
  - [ ] Implement handler generation following documented Handlers.add patterns (name, match, handle functions)
  - [ ] Add process initialization code generation with proper state management
  - [ ] Create unit tests for process structure generation with documented AO patterns

- [ ] **Provide Process Templates for Common Use Cases** (AC: 4)
  - [ ] Create process template library based on AO tutorials and documentation examples
  - [ ] Implement template selection logic based on user requirements analysis
  - [ ] Add templates for tokens, chatrooms, bots, games from existing AO documentation
  - [ ] Create unit tests for template selection and customization logic

- [ ] **Include Automatic Validation with EvalProcess** (AC: 5)
  - [ ] Integrate `EvalProcessCommand` into the deployment workflow for handler testing
  - [ ] Implement automated test case generation based on generated handlers
  - [ ] Add validation logic for process initialization and handler functionality
  - [ ] Create integration tests for automatic validation workflow

- [ ] **Enable Iterative Refinement Process** (AC: 6)
  - [ ] Implement feedback analysis system for process testing results
  - [ ] Create refinement logic that queries additional documentation based on test failures
  - [ ] Add code regeneration capabilities based on test feedback and documentation insights
  - [ ] Create integration tests for iterative refinement workflow

- [ ] **Support Deployment Verification** (AC: 7)
  - [ ] Integrate `ExecuteActionCommand` for message testing and process interaction validation
  - [ ] Implement state inspection capabilities using `QueryAOProcessMessagesCommand`
  - [ ] Add deployment health checks and functionality verification
  - [ ] Create integration tests for deployment verification workflows

- [ ] **Create Unified MCP Tool Command** (AC: 1-7)
  - [ ] Create new MCP tool command `CreateGuidedProcessCommand` following existing tool patterns
  - [ ] Implement tool parameters schema using Zod validation for natural language requirements
  - [ ] Integrate with ProcessToolFactory or create new GuidedProcessToolFactory
  - [ ] Add comprehensive unit tests for guided process creation tool command

- [ ] **Quality Assurance**
  - [ ] Run npm run build to ensure no build errors
  - [ ] Run npm run lint to verify code quality
  - [ ] Run npm run type-check to ensure TypeScript compliance
  - [ ] Run npm run test to verify all tests pass

## Dev Notes

### Previous Story Insights

From Story 7.1 (Create Intelligent Documentation-to-Code Workflow Integration):

- Successfully implemented complete end-to-end workflow from user requirements to Lua code generation
- Established comprehensive service architecture with LuaWorkflowOrchestrationService, RequirementAnalysisService, LuaCodeGeneratorService, and CodeExplanationService
- Created 47 unit tests and 11 integration tests with excellent coverage and quality
- Generated code follows AO best practices with proper handler patterns and documentation references
- All services follow established TypeScript patterns with proper dependency injection

### Data Models

**Guided Process Creation Interface** [Source: Epic 7.2 technical requirements and Story 7.1 architecture]:

```typescript
interface GuidedProcessCreation {
  analyzeRequirements(userRequest: string): Promise<RequirementAnalysis>;
  generateProcessCode(
    requirements: RequirementAnalysis,
    docs: PermawebDocsResult[],
  ): Promise<ProcessCodeResult>;
  createProcess(): Promise<ProcessCreationResult>;
  deployCode(
    processId: string,
    code: ProcessCodeResult,
  ): Promise<DeploymentResult>;
  validateDeployment(
    processId: string,
    handlers: HandlerInfo[],
  ): Promise<ValidationResult>;
}
```

**Process Deployment Workflow Interface** [Source: Epic 7.2 workflow requirements]:

```typescript
interface ProcessDeploymentWorkflow {
  executeFullWorkflow(userRequest: string): Promise<GuidedDeploymentResult>;
  executeWorkflowStep(
    step: WorkflowStep,
    context: WorkflowContext,
  ): Promise<StepResult>;
  handleWorkflowError(
    error: WorkflowError,
    context: WorkflowContext,
  ): Promise<ErrorRecovery>;
  generateWorkflowReport(results: WorkflowResults): Promise<DeploymentReport>;
}
```

**Process Code Result Extension** [Source: Story 7.1 LuaCodeResult with process-specific additions]:

```typescript
interface ProcessCodeResult extends LuaCodeResult {
  processStructure: {
    initializationCode: string;
    stateDefinition: string;
    handlers: HandlerDefinition[];
    utilityFunctions: string[];
  };
  templateUsed: ProcessTemplate;
  testCases: ProcessTestCase[];
  deploymentInstructions: string[];
}
```

### API Specifications

**Guided Process Creation Service** [Source: src/services/ pattern following existing services]:

```typescript
// src/services/GuidedProcessCreationService.ts
export class GuidedProcessCreationService {
  constructor(
    private luaWorkflowService: LuaWorkflowOrchestrationService,
    private processCreationService: ProcessCreationService, // from existing tools
    private processEvaluationService: ProcessEvaluationService, // from existing tools
  ) {}

  async createGuidedProcess(userRequest: string): Promise<GuidedProcessResult>;
  async generateProcessWithDocs(
    requirements: RequirementAnalysis,
  ): Promise<ProcessCodeResult>;
  async deployAndValidate(
    processCode: ProcessCodeResult,
  ): Promise<DeploymentResult>;
}
```

**Process Deployment Workflow Service** [Source: Epic 7.2 end-to-end workflow requirements]:

```typescript
// src/services/ProcessDeploymentWorkflowService.ts
export class ProcessDeploymentWorkflowService {
  constructor(
    private guidedCreationService: GuidedProcessCreationService,
    private validationService: ProcessValidationService,
    private refinementService: ProcessRefinementService,
  ) {}

  async executeDeploymentWorkflow(userRequest: string): Promise<WorkflowResult>;
  async validateAndRefine(
    processId: string,
    testResults: ValidationResult[],
  ): Promise<RefinementResult>;
  async generateDeploymentReport(
    workflowResults: WorkflowResult,
  ): Promise<DeploymentReport>;
}
```

**MCP Tool Command** [Source: src/tools/process/commands/ following ProcessToolFactory patterns]:

```typescript
// src/tools/process/commands/CreateGuidedProcessCommand.ts
export class CreateGuidedProcessCommand extends ToolCommand<
  CreateGuidedProcessArgs,
  string
> {
  protected metadata: ToolMetadata = {
    name: "createGuidedProcess",
    title: "Create Guided AO Process with Documentation",
    description:
      "Create, deploy, and test AO process from natural language requirements with automatic documentation reference and validation",
  };

  protected parametersSchema = z.object({
    userRequest: z
      .string()
      .describe(
        "Natural language description of the desired AO process functionality",
      ),
    processType: z
      .enum(["token", "chatroom", "bot", "game", "custom"])
      .optional()
      .describe("Specific process type hint for template selection"),
    includeTesting: z
      .boolean()
      .optional()
      .describe("Include automatic validation and testing"),
    allowRefinement: z
      .boolean()
      .optional()
      .describe("Enable iterative refinement based on test results"),
  });
}
```

### Component Specifications

**Process Template Library** [Source: Epic 7.2 template requirements and docs/process-workflows.md patterns]:

- Token process templates based on embedded AO token patterns
- Chatroom templates following AO communication examples
- Bot process templates with message handling and AI integration patterns
- Game process templates with state management and player interaction
- Custom templates derived from documentation examples and best practices

**Validation and Testing Integration** [Source: docs/process-workflows.md testing patterns]:

- Integration with EvalProcessCommand for code deployment testing
- Integration with ExecuteActionCommand for handler functionality testing
- Integration with QueryAOProcessMessagesCommand for deployment verification
- Automated test case generation based on handler definitions

**Iterative Refinement System** [Source: Epic 7.2 refinement requirements]:

- Test result analysis to identify failures and improvement areas
- Additional documentation querying based on specific failure patterns
- Code regeneration with focused improvements and error corrections
- Re-deployment and validation workflow for refined processes

### File Locations

**Files to Create**:

- `src/services/GuidedProcessCreationService.ts` - Main guided process creation service
- `src/services/ProcessDeploymentWorkflowService.ts` - End-to-end workflow orchestration
- `src/services/ProcessValidationService.ts` - Process validation and testing logic
- `src/services/ProcessRefinementService.ts` - Iterative refinement and improvement
- `src/tools/process/commands/CreateGuidedProcessCommand.ts` - MCP tool command for guided creation
- `src/types/guided-process.ts` - TypeScript interfaces for guided process workflow
- `tests/unit/services/GuidedProcessCreationService.unit.test.ts` - Unit tests for guided creation
- `tests/unit/services/ProcessDeploymentWorkflowService.unit.test.ts` - Unit tests for workflow
- `tests/unit/services/ProcessValidationService.unit.test.ts` - Unit tests for validation
- `tests/unit/services/ProcessRefinementService.unit.test.ts` - Unit tests for refinement
- `tests/unit/tools/process/CreateGuidedProcessCommand.unit.test.ts` - Unit tests for tool command
- `tests/integration/GuidedProcessWorkflow.integration.test.ts` - Integration tests for complete workflow

**Files to Modify**:

- `src/tools/process/ProcessToolFactory.ts` - Add CreateGuidedProcessCommand to factory
- `src/tools/process/commands/index.ts` - Export new command
- `src/services/LuaCodeGeneratorService.ts` - Extend with process structure generation capabilities
- `src/types/lua-workflow.ts` - Add process-specific interfaces and types

**Reference Files**:

- `src/services/LuaWorkflowOrchestrationService.ts:1-200` - Workflow orchestration patterns from Story 7.1
- `src/tools/process/commands/CreateProcessCommand.ts:1-80` - Process creation command patterns
- `src/tools/process/commands/EvalProcessCommand.ts:1-90` - Process evaluation integration patterns
- `src/tools/process/commands/ExecuteActionCommand.ts:1-120` - Process communication patterns
- `docs/process-workflows.md:1-433` - Complete process lifecycle and integration patterns

### Testing Requirements

**Unit Testing Strategy** [Source: docs/architecture/coding-standards.md and Story 7.1 patterns]:

- Use Vitest 3.1+ framework with TypeScript support and comprehensive coverage reporting
- Mock CreateProcessCommand, EvalProcessCommand, ExecuteActionCommand for controlled testing
- Test guided process creation logic with various user input patterns and process types
- Validate process template selection and customization logic
- Test workflow orchestration with error handling and recovery scenarios

**Integration Testing Requirements**:

- End-to-end guided process creation workflow from user request to deployed process
- Cross-service integration between all process tools and documentation services
- Process deployment validation with real process creation and evaluation
- Template-based process generation testing with actual AO process patterns
- Iterative refinement testing with simulated test failures and improvements

**Test Coverage Requirements**:

- 90% test coverage for guided process creation workflow functionality
- Comprehensive testing of process template selection and generation
- Validation workflow testing with mocked process responses and real integration patterns
- Error handling and recovery testing for all workflow steps

### Technical Constraints

**TypeScript and Framework Requirements** [Source: docs/architecture/tech-stack.md]:

- TypeScript 5.8+ with strict typing enabled (no `any` usage)
- FastMCP 1.27+ framework patterns for tool command implementation
- Node.js 20+ runtime environment for service execution
- Integration with existing AO Connect 0.0.85 for process operations

**Service Integration Constraints** [Source: existing process tools and Story 7.1 architecture]:

- Must integrate with existing CreateProcessCommand, EvalProcessCommand, ExecuteActionCommand interfaces
- Follow established ToolCommand patterns from ProcessToolFactory
- Maintain compatibility with Story 7.1 LuaWorkflowOrchestrationService interface
- Adhere to ToolContext patterns for keyPair and hub access from existing process tools

**Process Creation Constraints** [Source: docs/process-workflows.md patterns]:

- Work within existing AO process creation patterns (3-second initialization delay, default AOS module)
- Follow documented process lifecycle patterns (creation → evaluation → testing → monitoring)
- Maintain compatibility with existing process template system (embedded token templates)
- Support existing process communication patterns (message handling, state management)

**Workflow Integration Constraints** [Source: Epic 7.2 requirements and existing tool architecture]:

- Integrate seamlessly with existing MCP server tool registration patterns
- Maintain compatibility with PermawebDocsService interface from Story 7.1
- Follow established error handling patterns from existing process tools
- Support existing process monitoring and message query capabilities

### Project Structure Notes

The guided process creation implementation aligns with the existing project structure:

- Service implementations follow established `src/services/` organization patterns [Source: docs/architecture/source-tree.md]
- MCP tool commands follow the factory pattern in `src/tools/process/` directory structure
- TypeScript interfaces follow the `src/types/` categorization approach with guided-process.ts
- Testing structure mirrors existing `tests/unit/` and `tests/integration/` patterns
- Integration with ProcessToolFactory maintains existing tool registration patterns
- Extension of Story 7.1 components follows established service architecture patterns

## Testing

### Testing Standards

**Test Framework**: Vitest 3.1+ with TypeScript support and coverage reporting [Source: docs/architecture/tech-stack.md]
**Test Location**: `tests/unit/` for unit tests, `tests/integration/` for integration tests [Source: docs/architecture/source-tree.md]
**Coverage Target**: 90% test coverage for guided process creation workflow functionality
**Test Pattern**: Mock external services, test workflow orchestration, validate process deployment

### Test Cases Required

**Guided Process Creation Unit Tests**:

- User requirement analysis with various process types (token, chatroom, bot, game, custom)
- Process template selection logic based on requirement analysis results
- Code generation integration with Story 7.1 LuaWorkflowOrchestrationService
- Process creation and deployment workflow coordination
- Error handling for process creation failures and validation errors

**Workflow Orchestration Integration Tests**:

- End-to-end workflow from user request through process deployment to validation
- Integration with existing CreateProcessCommand, EvalProcessCommand, ExecuteActionCommand
- Process template application and customization based on user requirements
- Automated validation workflow with handler testing and deployment verification
- Iterative refinement workflow with test feedback and code regeneration

**Process Validation Tests**:

- Handler functionality testing using EvalProcessCommand integration
- Process communication testing using ExecuteActionCommand integration
- Deployment verification using QueryAOProcessMessagesCommand integration
- Error detection and recovery for failed process deployments

**Tool Command Tests**:

- MCP tool parameter validation using Zod schema with various input combinations
- Tool execution workflow including success and error response handling
- Integration with existing ProcessToolFactory patterns and tool registration
- Context handling for keyPair access and hub configuration from existing process tools

## Change Log

| Date       | Version | Description                                                                    | Author |
| ---------- | ------- | ------------------------------------------------------------------------------ | ------ |
| 2025-01-13 | 1.0     | Initial story creation for guided Lua process creation and deployment workflow | Claude |

## QA Results

### Review Date: 2025-01-14

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

**Overall Assessment**: Implementation demonstrates strong architectural principles with comprehensive service-oriented design. The guided process creation workflow successfully integrates Story 7.1's documentation-informed code generation with process deployment and validation capabilities. Code structure follows established patterns and TypeScript best practices.

**Architectural Strengths**:

- Clean separation of concerns across service layers
- Proper dependency injection patterns throughout service constructors
- Comprehensive type safety with well-defined interfaces
- Integration with existing process tools maintains compatibility
- End-to-end workflow orchestration with proper error recovery

**Implementation Quality**:

- Services follow established naming conventions and file organization
- Comprehensive interface compliance with proper type definitions
- Integration with ProcessToolFactory maintains existing architectural patterns
- Test coverage includes both unit and integration testing approaches

### Refactoring Performed

**File**: `src/services/ProcessDeploymentWorkflowService.ts`

- **Change**: Eliminated unsafe 'any' types and improved type safety throughout workflow execution
- **Why**: Type safety is critical for maintainability and preventing runtime errors in complex workflow orchestration
- **How**: Added proper type assertions and imported required type definitions for structured data flow

**File**: `src/services/ProcessDeploymentWorkflowService.ts`

- **Change**: Fixed architectural concern with private property access pattern
- **Why**: Accessing private properties breaks encapsulation and creates fragile coupling between services
- **How**: Replaced private property access with proper service instantiation for workflow dependencies

**File**: `src/services/GuidedProcessCreationService.ts`

- **Change**: Enhanced error handling with meaningful error responses and complete type structure
- **Why**: Proper error handling prevents cascading failures and provides actionable debugging information
- **How**: Added comprehensive error response structures with all required ProcessCodeResult properties

**File**: Both services

- **Change**: Improved method parameter typing to eliminate 'any' usage
- **Why**: Strong typing prevents type-related runtime errors and improves IDE support
- **How**: Added proper interface definitions and type constraints for method parameters

### Compliance Check

- **Coding Standards**: ✓ Follows project TypeScript patterns, proper imports with .js extensions, strict typing enabled
- **Project Structure**: ✓ Services organized in src/services/, tools in src/tools/process/commands/, tests mirror source structure
- **Testing Strategy**: ✓ Comprehensive unit tests for services, integration tests for workflow, proper mocking patterns
- **All ACs Met**: ✓ All acceptance criteria implemented with proper integration and validation workflows

### Improvements Checklist

- [x] Enhanced type safety by eliminating 'any' types (ProcessDeploymentWorkflowService.ts)
- [x] Fixed architectural concern with private property access (ProcessDeploymentWorkflowService.ts)
- [x] Improved error handling with meaningful error messages (GuidedProcessCreationService.ts)
- [x] Added proper interface compliance for ProcessCodeResult type (GuidedProcessCreationService.ts)
- [x] Verified all services follow established dependency injection patterns
- [x] Confirmed ProcessToolFactory integration maintains existing architectural patterns
- [x] Validated comprehensive test coverage with proper mocking strategies

### Security Review

**No security concerns identified**. Implementation follows secure coding practices:

- No hardcoded credentials or sensitive data exposure
- Proper error handling prevents information leakage
- JWKInterface usage follows established authentication patterns
- Process creation and evaluation follow existing security boundaries

### Performance Considerations

**Implementation demonstrates good performance practices**:

- Efficient service instantiation with dependency injection
- Proper async/await usage throughout workflow orchestration
- Template-based code generation reduces repeated processing
- Validation workflows designed for early failure detection
- Memory-efficient error handling without resource leaks

**Potential optimizations identified but not critical**:

- Workflow service instances could be reused across multiple requests
- Documentation query caching could improve response times for repeated requests

### Final Status

✓ **Approved - Ready for Done**

**Summary**: Implementation successfully delivers all acceptance criteria with high code quality standards. The guided process creation workflow provides comprehensive end-to-end functionality from natural language requirements through deployed and validated AO processes. Architecture maintains consistency with existing codebase patterns while introducing robust new capabilities. All refactoring issues have been addressed and quality standards met.
