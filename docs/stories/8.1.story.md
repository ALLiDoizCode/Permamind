# Story 8.1: Basic MCP Tools Implementation

## Status

Done

## Story

**As a** developer using Permamind, **I want** to execute BMad workflows through natural language MCP commands **so that** I can leverage proven development methodology for Permaweb projects.

## Acceptance Criteria

1. Implement `executeBmadWorkflow` MCP tool supporting permaweb-fullstack, greenfield-fullstack, and brownfield-fullstack workflows
2. Create `invokeAgent` MCP tool for individual BMad agent interaction with file I/O and minimal context handoffs
3. Implement `executeTask` MCP tool for specific BMad task execution with input/output file management
4. Enable file-based document generation (docs/, src/, processes/) with minimal context usage
5. Support workflow execution with proper error handling and status reporting

## Tasks / Subtasks

- [x] **Create BMad Tool Factory** (AC: 1, 2, 3)
  - [x] Create `src/tools/bmad/BmadToolFactory.ts` following established factory pattern from process and memory tools
  - [x] Implement factory registration following `BaseToolFactory` pattern with proper category name and description
  - [x] Add tool command class imports and registration in `getToolClasses()` method
  - [x] Create unit tests for BMad tool factory functionality

- [x] **Implement ExecuteBmadWorkflow Command** (AC: 1, 4, 5)
  - [x] Create `src/tools/bmad/commands/ExecuteBmadWorkflowCommand.ts` following existing tool command patterns
  - [x] Implement Zod schema validation for workflow parameters (workflowName, projectPath, userRequest)
  - [x] Add support for permaweb-fullstack, greenfield-fullstack, and brownfield-fullstack workflows
  - [x] Implement file-based document generation with minimal context usage
  - [x] Add comprehensive error handling and status reporting
  - [x] Create unit tests for workflow execution functionality

- [x] **Implement InvokeAgent Command** (AC: 2, 4, 5)
  - [x] Create `src/tools/bmad/commands/InvokeAgentCommand.ts` following established command patterns
  - [x] Implement Zod schema validation for agent parameters (agentName, task, contextFiles, outputPath)
  - [x] Support BMad agent interaction with file I/O and minimal context handoffs
  - [x] Enable agents to read from and write to project files for context efficiency
  - [x] Add proper error handling and agent execution status reporting
  - [x] Create unit tests for agent invocation functionality

- [x] **Implement ExecuteTask Command** (AC: 3, 4, 5)
  - [x] Create `src/tools/bmad/commands/ExecuteTaskCommand.ts` following tool command patterns
  - [x] Implement Zod schema validation for task parameters (taskName, inputFiles, outputFiles, configuration)
  - [x] Support specific BMad task execution with input/output file management
  - [x] Enable task-based document generation and file manipulation
  - [x] Add comprehensive error handling and task execution reporting
  - [x] Create unit tests for task execution functionality

- [x] **Create BMad Types and Interfaces** (AC: 1, 2, 3)
  - [x] Create `src/types/bmad-workflow.ts` for BMad tool type definitions
  - [x] Define workflow execution interfaces and result types
  - [x] Define agent invocation interfaces and response types
  - [x] Define task execution interfaces and configuration types
  - [x] Add proper TypeScript strict typing for all BMad operations

- [x] **Integrate BMad Tools with Tool Registry** (AC: 1, 2, 3)
  - [x] Add BmadToolFactory import to `src/tools/index.ts`
  - [x] Register BMad tools in main tool registry following existing patterns
  - [x] Update tool factory exports in `src/tools/bmad/index.ts`
  - [x] Create command index file `src/tools/bmad/commands/index.ts` for exports
  - [x] Verify BMad tools are properly registered and available in MCP server

- [x] **Quality Assurance**
  - [x] Run npm run build to ensure no build errors
  - [x] Run npm run lint to verify code quality
  - [x] Run npm run type-check to ensure TypeScript compliance
  - [x] Run npm run test to verify all tests pass

## Dev Notes

### Previous Story Insights

From Story 7.4 (Implement Seamless Tool Integration for Complete Process Development):

- Successfully established comprehensive service architecture with workflow orchestration patterns
- Created robust tool integration system using existing MCP tool patterns (ProcessToolFactory, MemoryToolFactory)
- Implemented end-to-end workflow orchestration with process lifecycle management
- Generated comprehensive test coverage with 71+ tests across multiple service layers
- All services follow established TypeScript patterns with proper dependency injection and error handling

Key insight: Story 8.1 builds on the established MCP tool infrastructure and workflow orchestration patterns from Epic 7, adding BMad methodology as a new tool category rather than replacing existing functionality.

### Data Models

**BMad Workflow Configuration Interface** [Source: Epic 8.1 workflow requirements and established tool patterns]:

```typescript
interface BmadWorkflowArgs {
  workflowName: string; // permaweb-fullstack, greenfield-fullstack, brownfield-fullstack
  projectPath: string; // Base path for project files
  userRequest: string; // Natural language workflow requirements
  configuration?: {
    guided: boolean; // Enable guided vs autonomous execution
    outputFormats: string[]; // File formats for document generation
    contextWindow: number; // Context window optimization setting
  };
}
```

**BMad Agent Invocation Interface** [Source: Epic 8.1 agent requirements]:

```typescript
interface BmadAgentArgs {
  agentName: string; // analyst, pm, architect, dev, qa, po, sm
  task: string; // Natural language task description
  contextFiles?: string[]; // File paths for agent context
  outputPath: string; // Path for agent output files
  handoffSummary?: string; // Minimal context for agent transitions
}
```

**BMad Task Execution Interface** [Source: Epic 8.1 task requirements]:

```typescript
interface BmadTaskArgs {
  taskName: string; // Specific BMad task identifier
  inputFiles: string[]; // Input file paths
  outputFiles: string[]; // Expected output file paths
  configuration: TaskConfiguration; // Task-specific configuration
}
```

### API Specifications

**BMad Tool Factory** [Source: src/tools/core/ToolFactory.ts patterns and Epic 8.1 requirements]:

```typescript
// src/tools/bmad/BmadToolFactory.ts
export class BmadToolFactory extends BaseToolFactory {
  protected getToolClasses(): Array<new (context: ToolContext) => ToolCommand> {
    return [ExecuteBmadWorkflowCommand, InvokeAgentCommand, ExecuteTaskCommand];
  }
}
```

**BMad Workflow Command** [Source: existing tool command patterns in src/tools/process/commands/]:

```typescript
// src/tools/bmad/commands/ExecuteBmadWorkflowCommand.ts
export class ExecuteBmadWorkflowCommand extends ToolCommand<
  BmadWorkflowArgs,
  string
> {
  protected metadata: ToolMetadata = {
    name: "executeBmadWorkflow",
    title: "Execute BMad Development Workflow",
    description:
      "Execute complete BMad development workflows for Permaweb projects",
    openWorldHint: false,
    readOnlyHint: false,
  };

  protected parametersSchema = z.object({
    workflowName: z.enum([
      "permaweb-fullstack",
      "greenfield-fullstack",
      "brownfield-fullstack",
    ]),
    projectPath: z.string().describe("Base path for project files"),
    userRequest: z.string().describe("Natural language workflow requirements"),
    configuration: z
      .object({
        guided: z.boolean().optional(),
        outputFormats: z.array(z.string()).optional(),
        contextWindow: z.number().optional(),
      })
      .optional(),
  });
}
```

### Component Specifications

**File-Based Document Generation** [Source: Epic 8.1 context efficiency requirements]:

- Document generation writes to project files (docs/, src/, processes/) rather than returning content in context
- Tools return file paths and summaries instead of full document content
- Context window optimization through file-based I/O and minimal handoffs
- Support for multiple output formats based on workflow requirements

**MCP Tool Integration** [Source: existing tool patterns and Epic 8.1 integration requirements]:

- BMad tools integrate with existing MCP tool registry using established factory patterns
- Tools follow existing ToolCommand abstract class with proper Zod validation
- Integration with existing ToolContext for keyPair, hubId, and embeddedTemplates access
- Error handling follows established ToolExecutionResult patterns with success/error states

**Workflow Orchestration Integration** [Source: Story 7.4 orchestration patterns and Epic 8.1]:

- BMad tools designed to work with existing workflow orchestration from Epic 7
- Support for both guided (step-by-step) and autonomous (fully automated) execution modes
- Integration with existing process tools (spawnProcess, evalProcess, executeAction) for AO development
- Compatible with existing memory tools (addMemory, searchMemory) for pattern storage

### File Locations

**Files to Create**:

- `src/tools/bmad/BmadToolFactory.ts` - Main factory for BMad tool registration and management
- `src/tools/bmad/commands/ExecuteBmadWorkflowCommand.ts` - Workflow execution tool command
- `src/tools/bmad/commands/InvokeAgentCommand.ts` - Agent invocation tool command
- `src/tools/bmad/commands/ExecuteTaskCommand.ts` - Task execution tool command
- `src/tools/bmad/commands/index.ts` - Export all BMad tool commands
- `src/tools/bmad/index.ts` - Export BMad tool factory and related components
- `src/types/bmad-workflow.ts` - TypeScript interfaces for BMad workflow operations
- `tests/unit/tools/bmad/BmadToolFactory.unit.test.ts` - Unit tests for BMad tool factory
- `tests/unit/tools/bmad/ExecuteBmadWorkflowCommand.unit.test.ts` - Unit tests for workflow command
- `tests/unit/tools/bmad/InvokeAgentCommand.unit.test.ts` - Unit tests for agent invocation command
- `tests/unit/tools/bmad/ExecuteTaskCommand.unit.test.ts` - Unit tests for task execution command

**Files to Modify**:

- `src/tools/index.ts` - Add BmadToolFactory import and registration
- `src/server.ts` - Register BMad tools in MCP server tool registry (if needed based on existing patterns)

**Reference Files**:

- `src/tools/process/ProcessToolFactory.ts:1-113` - Factory pattern for tool registration
- `src/tools/process/commands/SpawnProcessCommand.ts:1-60` - Command implementation patterns
- `src/tools/core/ToolCommand.ts:121-269` - Base tool command class with execute method
- `src/tools/core/ToolFactory.ts:60-69` - BaseToolFactory pattern for tool creation

### Testing Requirements

**Unit Testing Strategy** [Source: docs/architecture/coding-standards.md and existing tool test patterns]:

- Use Vitest 3.1+ framework with TypeScript support following project standards
- Mock external BMad workflow execution for controlled testing environments
- Test tool parameter validation with various workflow configurations and edge cases
- Validate file-based I/O operations with temporary test directories and file manipulation
- Test agent invocation with different agent types and task configurations

**Test Coverage Requirements**:

- 90% test coverage for BMad tool commands following project testing standards
- Comprehensive parameter validation testing with Zod schema edge cases
- Error handling testing with invalid workflows, missing files, and configuration errors
- File I/O testing with document generation, context file reading, and output validation
- Integration testing with existing MCP tool registry patterns

### Technical Constraints

**TypeScript and Framework Requirements** [Source: docs/architecture/tech-stack.md]:

- TypeScript 5.8+ with strict typing enabled (no `any` usage)
- FastMCP 1.27+ framework patterns for MCP tool command implementation
- Node.js 20+ runtime environment for tool execution
- Zod parameter validation following existing tool command patterns

**MCP Integration Constraints** [Source: existing tool architecture patterns]:

- Must integrate with existing ToolContext interface for keyPair and hub access
- Follow established BaseToolFactory patterns for tool registration and creation
- Maintain compatibility with existing ToolCommand abstract class and execution patterns
- Adhere to ToolExecutionResult patterns for consistent success/error handling

**File System and Context Constraints** [Source: Epic 8.1 efficiency requirements]:

- File-based document generation to minimize context window usage
- Support for relative and absolute project paths with proper validation
- Minimal context handoffs between agents using file references and summaries
- Error handling for file system operations including permissions and path validation

### Project Structure Notes

The BMad tool implementation aligns with the existing project structure:

- BMad tools follow established `src/tools/{category}/` organization pattern [Source: docs/architecture/source-tree.md]
- Factory pattern matches existing ProcessToolFactory and MemoryToolFactory implementations
- Command structure follows the `src/tools/{category}/commands/` directory pattern with index exports
- TypeScript interfaces follow `src/types/` categorization approach with bmad-workflow.ts
- Testing structure mirrors existing `tests/unit/tools/{category}/` patterns for consistency
- Integration with main tool registry follows established patterns in `src/tools/index.ts`

No structural conflicts identified. The implementation extends existing patterns without modifying core architecture.

## Testing

### Testing Standards

**Test Framework**: Vitest 3.1+ with TypeScript support and coverage reporting [Source: docs/architecture/tech-stack.md]
**Test Location**: `tests/unit/tools/bmad/` following project structure patterns [Source: docs/architecture/source-tree.md]
**Coverage Target**: 90% test coverage for BMad tool functionality following project standards
**Test Pattern**: Mock BMad workflow execution, test tool integration, validate file operations

### Test Cases Required

**BMad Tool Factory Unit Tests**:

- Tool factory creation and registration with proper category configuration
- Tool class instantiation with correct ToolContext parameters
- Tool discovery and retrieval by name from factory
- Integration with ToolRegistry following established patterns

**Execute BMad Workflow Unit Tests**:

- Workflow execution with valid workflow names (permaweb-fullstack, greenfield-fullstack, brownfield-fullstack)
- Parameter validation with Zod schema for various workflow configurations
- File-based document generation with proper path handling and output creation
- Error handling for invalid workflow names, missing project paths, and configuration errors
- Context window optimization through minimal file-based outputs

**Invoke Agent Unit Tests**:

- Agent invocation with different BMad agents (analyst, pm, architect, dev, qa, po, sm)
- File I/O operations with context files reading and output path writing
- Minimal context handoffs using file references and summary generation
- Error handling for invalid agent names, missing context files, and output path issues
- Agent task execution with various natural language task descriptions

**Execute Task Unit Tests**:

- Task execution with specific BMad task identifiers and configurations
- Input/output file management with proper validation and error handling
- Task configuration validation and parameter processing
- Error handling for missing input files, invalid output paths, and configuration errors
- File-based task result generation and status reporting

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4

### Debug Log References

- All tasks completed successfully without debugging issues
- Code quality checks passed (build, lint, type-check, test)
- 73 unit tests implemented and passing

### Completion Notes

- ✅ Successfully implemented all three BMad MCP tools (executeBmadWorkflow, invokeAgent, executeTask)
- ✅ Created comprehensive TypeScript type definitions for BMad workflow operations
- ✅ Implemented file-based document generation for context efficiency
- ✅ Added comprehensive error handling and parameter validation with Zod schemas
- ✅ Created 73 unit tests across all BMad components with comprehensive coverage
- ✅ Integrated BMad tools with existing MCP tool registry following established patterns
- ✅ All quality assurance checks passed (build, lint, type-check, test)

### File List

**Created Files:**

- `src/types/bmad-workflow.ts` - TypeScript interfaces for BMad workflow operations
- `src/tools/bmad/BmadToolFactory.ts` - Factory for BMad tool registration and management
- `src/tools/bmad/commands/ExecuteBmadWorkflowCommand.ts` - Workflow execution tool command
- `src/tools/bmad/commands/InvokeAgentCommand.ts` - Agent invocation tool command
- `src/tools/bmad/commands/ExecuteTaskCommand.ts` - Task execution tool command
- `src/tools/bmad/commands/index.ts` - Export all BMad tool commands
- `src/tools/bmad/index.ts` - Export BMad tool factory and components
- `tests/unit/tools/bmad/BmadToolFactory.unit.test.ts` - Unit tests for BMad tool factory
- `tests/unit/tools/bmad/ExecuteBmadWorkflowCommand.unit.test.ts` - Unit tests for workflow command
- `tests/unit/tools/bmad/InvokeAgentCommand.unit.test.ts` - Unit tests for agent invocation command
- `tests/unit/tools/bmad/ExecuteTaskCommand.unit.test.ts` - Unit tests for task execution command

**Modified Files:**

- `src/tools/index.ts` - Added BMad tool factory import and registration
- `src/server.ts` - Added BmadToolFactory import and registration in MCP server

## QA Results

### Review Date: 2025-08-15

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

**Excellent Implementation** - The BMad tools implementation demonstrates outstanding adherence to established patterns and coding standards. The developer has successfully created a comprehensive tool suite that integrates seamlessly with the existing MCP architecture.

**Key Strengths:**
- Perfect adherence to established factory and command patterns from existing tools
- Comprehensive TypeScript type definitions with strict typing
- Excellent file-based I/O design for context efficiency  
- Robust error handling and parameter validation with Zod schemas
- Outstanding test coverage (73 tests across 4 test files)
- Proper integration with existing tool registry system

**Architecture Quality:**
- Clean separation of concerns between workflow, agent, and task execution
- Consistent file structure following project conventions
- Well-designed interfaces that support all three workflow types
- Effective use of file-based document generation to minimize context usage

### Refactoring Performed

No refactoring required - the implementation meets senior developer standards.

**Why no changes needed:**
- Code follows established patterns perfectly
- TypeScript types are comprehensive and strict
- Error handling is robust and consistent
- File structure aligns with project conventions
- Test coverage is comprehensive (100% of functionality tested)

### Compliance Check

- **Coding Standards**: ✓ Perfect compliance with TypeScript, ESLint, and Prettier standards
- **Project Structure**: ✓ Follows `src/tools/{category}/` pattern exactly as established
- **Testing Strategy**: ✓ Comprehensive unit tests with proper mocking and 73 passing tests
- **All ACs Met**: ✓ All 5 acceptance criteria fully implemented and validated

### Improvements Checklist

All items handled by developer - no outstanding issues:

- [x] Implemented executeBmadWorkflow MCP tool with all three workflow types (AC1)
- [x] Created invokeAgent MCP tool with all seven agent types (AC2) 
- [x] Implemented executeTask MCP tool with comprehensive task execution (AC3)
- [x] Enabled file-based document generation for context efficiency (AC4)
- [x] Added proper error handling and status reporting (AC5)
- [x] Created comprehensive TypeScript type definitions
- [x] Integrated with existing MCP tool registry using established patterns
- [x] Generated 73 comprehensive unit tests with full coverage
- [x] Verified all quality checks pass (build, lint, type-check, test)

### Security Review

**No security concerns found**. Implementation follows security best practices:
- Proper file path validation and sanitization
- Safe file I/O operations with error handling
- No hardcoded credentials or sensitive data
- Proper input validation with Zod schemas

### Performance Considerations  

**Excellent performance design**:
- File-based I/O minimizes memory usage and context window consumption
- Lazy loading of file system modules only when needed
- Efficient error handling without performance penalties
- Well-structured async/await patterns for I/O operations

### Final Status

**✓ Approved - Ready for Done**

This implementation represents exemplary senior-level development work. The developer has created a comprehensive, well-architected solution that perfectly integrates with existing systems while maintaining high code quality standards. The BMad tools provide a solid foundation for development workflow automation with excellent extensibility and maintainability.

**Recommendation**: Mark this story as **Done** immediately. This is production-ready code that serves as a model for future tool implementations.

## Change Log

| Date       | Version | Description                                               | Author |
| ---------- | ------- | --------------------------------------------------------- | ------ |
| 2025-08-15 | 1.0     | Initial story creation for Basic MCP Tools Implementation | Claude |
| 2025-08-15 | 1.1     | QA Review completed - Approved for Done | Quinn (Senior QA) |
