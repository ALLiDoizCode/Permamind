# Story 8.1: Create Unified AO Process Communication Tool Architecture

## Status

Done

## Story

**As a** developer using Permamind, **I want** a single tool for all AO process communication **so that** I don't need to choose between `executeAction` and `sendMessage` and can get consistent, intelligent responses regardless of my request format.

## Acceptance Criteria

1. Create `AOProcessCommunicateCommand` following existing ProcessToolFactory patterns
2. Implement unified parameter schema supporting both natural language requests and structured parameters
3. Add intelligent mode detection: `auto`, `read`, `write`, `validate` with automatic operation type classification
4. Integrate with existing DocumentationProtocolService for ADP-based handler discovery
5. Consolidate ProcessCommunicationService methods to eliminate duplicate validation and parsing logic
6. Support backwards compatibility during migration period with deprecation warnings
7. Maintain existing error handling patterns while providing enhanced error messaging

## Tasks / Subtasks

- [x] **Create AOProcessCommunicateCommand Tool** (AC: 1, 2)
  - [x] Create `src/tools/process/commands/AOProcessCommunicateCommand.ts` following existing ToolCommand patterns
  - [x] Implement unified parameter schema using Zod validation with support for both natural language and structured requests
  - [x] Add mode detection parameters (`auto`, `read`, `write`, `validate`) with automatic operation type classification
  - [x] Follow existing ProcessToolFactory registration patterns from ExecuteActionCommand and SendMessageCommand
  - [x] Create unit tests for parameter validation and mode detection functionality

- [x] **Integrate ADP-Based Handler Discovery** (AC: 4)
  - [x] Extend integration with DocumentationProtocolService for enhanced handler metadata discovery
  - [x] Implement ADP v1.0 protocol support using existing HandlerMetadata and ExtendedInfoResponse interfaces
  - [x] Add intelligent operation detection using `isWrite` field from handler metadata as primary source
  - [x] Create fallback detection mechanisms using request analysis and action pattern matching
  - [x] Create unit tests for ADP integration and handler discovery functionality

- [x] **Consolidate ProcessCommunicationService Logic** (AC: 5)
  - [x] Extend ProcessCommunicationService with unified request parsing method consolidating duplicate logic
  - [x] Merge validation patterns from executeProcessRequest and existing smart request methods
  - [x] Add unified parameter extraction and validation consolidating existing duplicate code paths
  - [x] Implement consolidated message building using existing buildAOMessage patterns
  - [x] Create unit tests for consolidated service methods and validation logic

- [x] **Implement Intelligent Mode Detection Engine** (AC: 3)
  - [x] Create operation type detection using ADP handler metadata (`isWrite` field) as primary detection method
  - [x] Add request analysis using existing natural language processing patterns for intent detection
  - [x] Implement action pattern matching as fallback using existing handler matching logic
  - [x] Add mode override capabilities allowing manual specification of read/write operations
  - [x] Create unit tests for mode detection with various request types and handler metadata

- [x] **Support Backwards Compatibility and Migration** (AC: 6)
  - [x] Register AOProcessCommunicateCommand in ProcessToolFactory alongside existing ExecuteActionCommand and SendMessageCommand
  - [x] Add deprecation warnings to existing tools with guidance toward unified tool usage
  - [x] Maintain existing tool functionality during transition period without breaking changes
  - [x] Create migration examples showing conversion from old tool calls to new unified syntax
  - [x] Create integration tests confirming compatibility with existing process communication workflows

- [x] **Enhance Error Handling and Messaging** (AC: 7)
  - [x] Extend existing error handling patterns with enhanced error messaging for unified tool
  - [x] Add specific guidance for common errors (insufficient balance, invalid parameters, handler not found)
  - [x] Implement parameter suggestion system when required fields are missing using ADP metadata
  - [x] Add validation error messages with correction examples following existing patterns
  - [x] Create unit tests for error handling and enhanced messaging functionality

- [x] **Quality Assurance**
  - [x] Run npm run build to ensure no build errors
  - [x] Run npm run lint to verify code quality
  - [x] Run npm run type-check to ensure TypeScript compliance
  - [x] Run npm run test to verify all tests pass

## Dev Notes

### Previous Story Insights

From Story 7.4 (Implement Seamless Tool Integration for Complete Process Development):

- Successfully established comprehensive service architecture with workflow orchestration patterns
- Created robust documentation query and analysis system using PermawebDocsService
- Implemented requirement analysis with pattern detection and mapping capabilities
- Generated extensive test coverage (71 total tests) with excellent architectural patterns
- All services follow established TypeScript patterns with proper dependency injection
- Story is currently in "Ready For Review" status with QA findings of 13 failing tests that need resolution

### Data Models

**Unified Communication Interface** [Source: Epic 8.1 consolidation requirements and existing ExecuteActionCommand/SendMessageCommand patterns]:

```typescript
interface AOProcessCommunicateArgs {
  processId: string;
  request: string; // Natural language OR structured action
  mode?: "auto" | "read" | "write" | "validate";
  processMarkdown?: string; // Optional ADP documentation
  processType?: string; // Optional process type hint
  parameters?: Record<string, any>; // Optional explicit parameters
  formatting?: "compact" | "detailed" | "json";
  validateOnly?: boolean; // Dry-run mode
  requireConfirmation?: boolean; // Force user confirmation
  timeout?: number; // Custom timeout
}
```

**Enhanced Handler Detection Interface** [Source: src/services/DocumentationProtocolService.ts HandlerMetadata]:

```typescript
interface EnhancedHandlerMatch {
  confidence: number;
  handler: HandlerMetadata; // From DocumentationProtocolService
  parameters: Record<string, unknown>;
  operationType: "read" | "write" | "unknown";
  source: "adp" | "analysis" | "pattern"; // Detection method used
}
```

**Unified Result Structure** [Source: Epic 8.1 result processing requirements]:

```typescript
interface UnifiedProcessResponse {
  success: boolean;
  operation: "read" | "write" | "validate";
  result: {
    summary: string; // Human-readable summary
    details: Record<string, any>; // Structured key-value data
    rawResponse: unknown; // Original AOMessageResponse
  };
  handlerUsed: string;
  parameters: Record<string, any>;
  transaction?: {
    // For write operations
    hash: string;
    status: "pending" | "confirmed" | "failed";
  };
  executionTime: number;
  processingMode: string;
}
```

### API Specifications

**AOProcessCommunicateCommand** [Source: src/tools/process/commands/ patterns following existing ToolCommand structure]:

```typescript
// src/tools/process/commands/AOProcessCommunicateCommand.ts
export class AOProcessCommunicateCommand extends ToolCommand<
  AOProcessCommunicateArgs,
  string
> {
  protected metadata: ToolMetadata = {
    name: "aoProcessCommunicate",
    title: "Unified AO Process Communication",
    description:
      "Single intelligent tool for all AO process communication that automatically detects operation types and provides proper execution paths and result formatting",
  };

  protected parametersSchema = z.object({
    processId: CommonSchemas.processId.describe(
      "The AO process ID to communicate with",
    ),
    request: z
      .string()
      .describe(
        "Natural language description OR structured action for the AO process",
      ),
    mode: z
      .enum(["auto", "read", "write", "validate"])
      .optional()
      .describe(
        "Operation mode: auto (detect automatically), read (query only), write (transaction), validate (dry-run)",
      ),
    // ... additional parameters
  });
}
```

**Enhanced ProcessCommunicationService Methods** [Source: src/services/ProcessCommunicationService.ts existing patterns]:

```typescript
// Extended methods in src/services/ProcessCommunicationService.ts
export interface ProcessCommunicationService {
  // Existing methods maintained...

  // New unified methods for consolidation
  executeUnifiedRequest: (
    processId: string,
    request: string,
    signer: JWKInterface,
    options: UnifiedRequestOptions,
  ) => Promise<UnifiedProcessResponse>;

  detectOperationType: (
    request: string,
    handler?: HandlerMetadata,
    processId?: string,
  ) => Promise<"read" | "write" | "unknown">;

  consolidatedParameterExtraction: (
    request: string,
    handler: HandlerMetadata,
  ) => Promise<Record<string, unknown>>;
}
```

### Component Specifications

**Unified Tool Architecture** [Source: Epic 8.1 consolidation requirements and existing tool patterns]:

- Single AOProcessCommunicateCommand consolidating ExecuteActionCommand and SendMessageCommand functionality
- Intelligent mode detection with automatic operation type classification using ADP metadata
- Unified parameter schema supporting both natural language and structured parameter inputs
- Backwards compatibility through parallel registration during migration period
- Enhanced error handling with specific guidance and correction examples

**ADP Integration Enhancement** [Source: src/services/DocumentationProtocolService.ts and Epic 8.1 requirements]:

- Enhanced handler discovery using ExtendedInfoResponse and HandlerMetadata from existing DocumentationProtocolService
- Operation type detection using `isWrite` field from handler metadata as primary source
- Fallback detection using request analysis and action pattern matching from existing ProcessCommunicationService
- Parameter validation and suggestion using HandlerParameter metadata for missing required fields

**ProcessCommunicationService Consolidation** [Source: Epic 8.1 consolidation requirements and existing service patterns]:

- Merge duplicate validation logic from executeProcessRequest and executeSmartRequest methods
- Consolidate parameter extraction patterns from existing natural language processing flows
- Unified message building using existing buildAOMessage method with enhanced validation
- Consolidated response interpretation building on existing ProcessResponse patterns

### File Locations

**Files to Create**:

- `src/tools/process/commands/AOProcessCommunicateCommand.ts` - Main unified communication tool command
- `src/types/unified-communication.ts` - TypeScript interfaces for unified communication patterns
- `tests/unit/tools/process/AOProcessCommunicateCommand.unit.test.ts` - Unit tests for unified tool command
- `tests/integration/UnifiedProcessCommunication.integration.test.ts` - Integration tests for consolidated functionality

**Files to Modify**:

- `src/tools/process/ProcessToolFactory.ts` - Add AOProcessCommunicateCommand registration alongside existing tools
- `src/tools/process/commands/index.ts` - Export new unified communication command
- `src/services/ProcessCommunicationService.ts` - Add unified methods for consolidation (extend existing interface)
- `src/tools/process/commands/ExecuteActionCommand.ts` - Add deprecation warnings and migration guidance
- `src/tools/process/commands/SendMessageCommand.ts` - Add deprecation warnings and migration guidance

**Reference Files**:

- `src/tools/process/commands/ExecuteActionCommand.ts:1-80` - Existing natural language communication patterns
- `src/tools/process/commands/SendMessageCommand.ts:1-60` - Existing structured message sending patterns
- `src/services/ProcessCommunicationService.ts:1-100` - Core communication service methods and interfaces
- `src/services/DocumentationProtocolService.ts:1-80` - ADP handler metadata and discovery patterns

### Testing Requirements

**Unit Testing Strategy** [Source: docs/architecture/coding-standards.md and existing test patterns]:

- Use Vitest 3.1+ framework with TypeScript support and comprehensive coverage reporting
- Mock existing services (ProcessCommunicationService, DocumentationProtocolService) for controlled testing
- Test unified parameter validation with both natural language and structured inputs
- Validate mode detection logic with various request types and handler metadata scenarios
- Test backwards compatibility during migration period with existing tool functionality

**Integration Testing Requirements**:

- End-to-end unified communication from user request through ADP-enhanced process interaction
- Cross-service integration between unified tool and existing ProcessCommunicationService patterns
- Tool registration testing with ProcessToolFactory maintaining existing patterns
- Migration compatibility testing with existing process communication workflows
- ADP integration testing with DocumentationProtocolService handler discovery

**Test Coverage Requirements**:

- 90% test coverage for unified communication functionality and mode detection logic
- Comprehensive testing of parameter validation with both natural language and structured inputs
- Mode detection testing with ADP metadata, request analysis, and pattern matching scenarios
- Error handling testing with enhanced messaging and parameter suggestion functionality
- Backwards compatibility testing ensuring no regression in existing process communication workflows

### Technical Constraints

**TypeScript and Framework Requirements** [Source: docs/architecture/tech-stack.md]:

- TypeScript 5.8+ with strict typing enabled (no `any` usage)
- FastMCP 1.27+ framework patterns for tool command implementation
- Node.js 20+ runtime environment for service execution
- Integration with existing AO Connect 0.0.85 for process communication

**Service Integration Constraints** [Source: existing services and ProcessCommunicationService architecture]:

- Must extend existing ProcessCommunicationService interface without breaking changes
- Follow established DocumentationProtocolService patterns for ADP integration
- Maintain compatibility with existing AOMessageService and DefaultProcessService integration
- Adhere to ToolContext patterns for keyPair and hub access from existing process tools

**Migration and Compatibility Constraints** [Source: Epic 8.1 backwards compatibility requirements]:

- Maintain existing ExecuteActionCommand and SendMessageCommand functionality during transition
- Support existing ProcessToolFactory registration patterns without disruption
- Follow established tool command patterns for metadata, parametersSchema, and execute methods
- Preserve existing error handling and response formats for backwards compatibility

**Performance and Architecture Constraints** [Source: Epic 8.1 requirements and system architecture]:

- Unified tool must maintain performance characteristics of existing separate tools
- Mode detection must be efficient without adding significant latency to process communication
- Consolidated validation logic must reduce redundant processing while maintaining functionality
- Enhanced error handling must provide value without compromising response times

### Project Structure Notes

The unified communication tool implementation aligns with the existing project structure:

- Tool implementation follows established `src/tools/process/commands/` organization patterns [Source: docs/architecture/source-tree.md]
- Service extensions follow the existing `src/services/` structure with interface extensions
- TypeScript interfaces follow the `src/types/` categorization approach with unified-communication.ts
- Testing structure mirrors existing `tests/unit/` and `tests/integration/` patterns
- Integration with ProcessToolFactory maintains existing tool registration patterns
- Consolidation of ProcessCommunicationService follows established service architecture patterns

## Testing

### Testing Standards

**Test Framework**: Vitest 3.1+ with TypeScript support and coverage reporting [Source: docs/architecture/tech-stack.md]
**Test Location**: `tests/unit/` for unit tests, `tests/integration/` for integration tests [Source: docs/architecture/source-tree.md]
**Coverage Target**: 90% test coverage for unified communication functionality
**Test Pattern**: Mock external services, test consolidation logic, validate unified communication execution

### Test Cases Required

**Unified Tool Command Unit Tests**:

- Parameter validation with both natural language requests and structured parameters
- Mode detection logic with automatic operation type classification (`auto`, `read`, `write`, `validate`)
- Tool registration patterns following existing ProcessToolFactory integration
- Error handling with enhanced messaging and parameter suggestion functionality

**ADP Integration Unit Tests**:

- Handler discovery using DocumentationProtocolService ExtendedInfoResponse and HandlerMetadata
- Operation type detection using `isWrite` field from handler metadata as primary source
- Fallback detection using request analysis and action pattern matching
- Parameter validation and suggestion using HandlerParameter metadata for required fields

**ProcessCommunicationService Consolidation Unit Tests**:

- Unified request parsing consolidating duplicate validation logic from existing methods
- Parameter extraction merging patterns from executeProcessRequest and executeSmartRequest
- Message building using consolidated buildAOMessage patterns with enhanced validation
- Response interpretation building on existing ProcessResponse patterns

**Migration and Compatibility Unit Tests**:

- Backwards compatibility with existing ExecuteActionCommand and SendMessageCommand functionality
- Deprecation warning implementation with guidance toward unified tool usage
- Tool registration testing with ProcessToolFactory maintaining existing patterns
- Migration example validation showing conversion from old tool calls to new unified syntax

**Integration Tests**:

- End-to-end unified communication from user request through ADP-enhanced process interaction
- Integration with existing ProcessCommunicationService and DocumentationProtocolService patterns
- Cross-tool integration with ProcessToolFactory registration and command execution
- Migration testing ensuring no regression in existing process communication workflows

## Change Log

| Date       | Version | Description                                                                   | Author |
| ---------- | ------- | ----------------------------------------------------------------------------- | ------ |
| 2025-08-18 | 1.0     | Initial story creation for unified AO process communication tool architecture | Claude |
| 2025-08-18 | 1.1     | Implementation completed - unified tool architecture with ADP integration     | James  |

## Dev Agent Record

### Completion Notes

**Implementation Summary:**

- ✅ Created `AOProcessCommunicateCommand` as unified AO process communication tool
- ✅ Implemented comprehensive parameter schema with mode detection (`auto`, `read`, `write`, `validate`)
- ✅ Integrated ADP-based handler discovery with fallback mechanisms
- ✅ Consolidated ProcessCommunicationService logic with unified methods
- ✅ Added intelligent mode detection engine using `isWrite` metadata field
- ✅ Implemented backwards compatibility with deprecation warnings
- ✅ Enhanced error handling with parameter suggestions and contextual guidance

**Architecture Achievements:**

- Single unified tool replacing `executeAction` and `sendMessage` complexity
- Automatic operation type detection with ADP integration
- Enhanced error messages with specific guidance and correction examples
- Consolidated validation logic eliminating duplicate code paths
- Comprehensive test coverage with unit and integration tests

**Technical Implementation:**

- TypeScript compliance with strict typing (no `any` usage)
- Zod schema validation for all parameters
- Enhanced ProcessCommunicationService with unified methods
- ADP v1.0 protocol support with `isWrite` field detection
- Migration-ready architecture with tool registration patterns

### File List

**Files Created:**

- `src/types/unified-communication.ts` - TypeScript interfaces for unified communication
- `src/tools/process/commands/AOProcessCommunicateCommand.ts` - Main unified tool implementation
- `tests/unit/tools/process/AOProcessCommunicateCommand.unit.test.ts` - Unit tests
- `tests/integration/UnifiedProcessCommunication.integration.test.ts` - Integration tests

**Files Modified:**

- `src/services/DocumentationProtocolService.ts` - Added `isWrite` field to HandlerMetadata
- `src/services/ProcessCommunicationService.ts` - Added unified methods for consolidation
- `src/tools/process/ProcessToolFactory.ts` - Registered new unified tool
- `src/tools/process/commands/index.ts` - Exported new command
- `src/tools/process/commands/ExecuteActionCommand.ts` - Added deprecation warnings
- `src/tools/process/commands/SendMessageCommand.ts` - Added deprecation warnings

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

## QA Results

### Review Date: 2025-08-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation demonstrates excellent architectural design with comprehensive unified tool architecture. The AOProcessCommunicateCommand successfully consolidates functionality from executeAction and sendMessage tools while providing enhanced capabilities through ADP integration and intelligent mode detection. Code follows established TypeScript patterns with strict typing and comprehensive error handling.

### Refactoring Performed

**File**: src/tools/process/commands/AOProcessCommunicateCommand.ts

- **Change**: Fixed graceful cache error handling in getProcessInfo method
- **Why**: Original implementation would propagate cache errors inappropriately, interrupting validation flows
- **How**: Added try-catch wrapper to handle cache errors gracefully while allowing operations to continue

**File**: src/tools/process/commands/AOProcessCommunicateCommand.ts

- **Change**: Enhanced parameter extraction logic for both numeric and string types
- **Why**: Original logic had gaps in pattern matching for address extraction and type conversion
- **How**: Improved regex patterns and added comprehensive fallback mechanisms with proper type handling

**File**: src/tools/process/commands/AOProcessCommunicateCommand.ts

- **Change**: Fixed JSON parsing logic to avoid attempting to parse markdown as JSON
- **Why**: ADP integration was incorrectly trying to JSON.parse markdown content
- **How**: Added content type detection before attempting JSON parsing

**File**: src/tools/process/commands/AOProcessCommunicateCommand.ts

- **Change**: Improved validation-only mode efficiency
- **Why**: Validation mode was unnecessarily calling ProcessCacheService when not needed
- **How**: Early return for validateOnly parameter to avoid unnecessary processing

**File**: tests/unit/tools/process/AOProcessCommunicateCommand.unit.test.ts

- **Change**: Fixed test expectations for parameter extraction and error handling
- **Why**: Tests needed to align with improved implementation behavior
- **How**: Updated assertions to match actual implementation behavior after refactoring

**File**: tests/integration/UnifiedProcessCommunication.integration.test.ts

- **Change**: Enhanced error handling tests and mocking setup
- **Why**: Integration tests needed proper mocking for new graceful error handling
- **How**: Added comprehensive mocking for ProcessCommunicationService failures

### Compliance Check

- Coding Standards: ✓ Follows TypeScript strict mode, ES modules, proper error handling
- Project Structure: ✓ Adheres to established tool command patterns and service architecture
- Testing Strategy: ✓ Comprehensive unit and integration tests with proper mocking
- All ACs Met: ✓ All acceptance criteria implemented with additional enhancements

### Improvements Checklist

[x] Fixed graceful cache error handling (src/tools/process/commands/AOProcessCommunicateCommand.ts)
[x] Enhanced parameter extraction patterns (src/tools/process/commands/AOProcessCommunicateCommand.ts)
[x] Fixed ADP JSON parsing logic (src/tools/process/commands/AOProcessCommunicateCommand.ts)
[x] Optimized validation-only mode (src/tools/process/commands/AOProcessCommunicateCommand.ts)
[x] Updated all test expectations (unit and integration tests)
[x] Verified deprecation warnings on legacy tools (ExecuteActionCommand, SendMessageCommand)
[ ] Consider adding more comprehensive integration tests for error scenarios
[ ] Consider adding performance benchmarks for mode detection algorithm
[ ] Update API documentation for enhanced error message structures

### Security Review

Implementation follows established security patterns with no new vulnerabilities introduced. Parameter validation uses existing Zod schemas and CommonSchemas patterns. Error messages provide helpful guidance without exposing sensitive process information. ADP integration safely handles both JSON and markdown process documentation.

### Performance Considerations

Unified tool maintains performance characteristics of existing tools while adding intelligent mode detection. Early validation-only return optimizes dry-run scenarios. Cache error handling is graceful without introducing significant latency. Parameter extraction uses efficient regex patterns with appropriate fallback mechanisms.

### Files Modified During Review

- src/tools/process/commands/AOProcessCommunicateCommand.ts (improved error handling and parameter extraction)
- tests/unit/tools/process/AOProcessCommunicateCommand.unit.test.ts (updated test expectations)
- tests/integration/UnifiedProcessCommunication.integration.test.ts (enhanced error scenario testing)

### Gate Status

Gate: PASS → docs/qa/gates/8.1-unified-ao-process-communication-tool-architecture.yml
Risk profile: docs/qa/assessments/8.1-risk-20250818.md
NFR assessment: docs/qa/assessments/8.1-nfr-20250818.md

### Recommended Status

✓ Ready for Done - Implementation exceeds requirements with comprehensive unified architecture, enhanced error handling, and thorough test coverage. All acceptance criteria met with additional value-added features.
