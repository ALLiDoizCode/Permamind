# Story 9.1: Fix Parameter Extraction and Translation Logic - Brownfield Enhancement

## Status

Draft

## Story

**As a** user of the executeAction tool, **I want** my natural language requests to be correctly translated into AO process parameters **so that** mathematical and operational commands work reliably without parameter parsing errors.

## Story Context

**Existing System Integration:**

- Integrates with: ADPProcessCommunicationService.extractParametersFromRequest and ExecuteActionCommand
- Technology: TypeScript + FastMCP + AO Connect + DocumentationProtocolService
- Follows pattern: Existing parameter extraction in ADPProcessCommunicationService
- Touch points: Parameter extraction logic, tag generation, natural language processing

**Issue Context:**

While Story 8.4 fixed the core ADP discovery pipeline, QA testing revealed parameter extraction issues in the ADPProcessCommunicationService. Users report that mathematical operations like "Add 5 and 3" are not being correctly translated to the A=5, B=3 parameters expected by calculator processes. The current parameter extraction logic has gaps in pattern matching for natural language inputs.

**Root Cause Analysis:**

1. **Parameter Parsing Problems:** Natural language like "Add 5 and 3" not translating to A=5, B=3 tags
2. **Tag Format Mismatch:** Calculator handlers expect msg.Tags.A and msg.Tags.B but extraction isn't setting these correctly  
3. **Input Validation Triggering:** "Invalid input" errors when valid numbers are provided in natural language
4. **Inconsistent Results:** Subtraction returning "1234" instead of proper calculations due to default value handling

## Acceptance Criteria

**Functional Requirements:**

1. Fix parameter extraction logic to correctly parse natural language patterns (e.g., "Add 5 and 3" â†’ A=5, B=3)
2. Implement robust pattern matching for mathematical operations, assignments, and common process interactions
3. Add comprehensive unit tests for parameter extraction with various natural language formats

**Integration Requirements:**

4. Existing ADPProcessCommunicationService interface continues to work unchanged
5. New functionality follows existing parameter extraction patterns
6. Integration with DocumentationProtocolService maintains current ADP compliance behavior

**Quality Requirements:**

7. Change is covered by comprehensive unit and integration tests
8. Parameter extraction patterns are documented for future maintenance  
9. No regression in existing successful parameter extractions verified

## Tasks / Subtasks

### Task 1: Analyze Current Parameter Extraction Logic (AC: 1, 9)

- [ ] Review current `extractParametersFromRequest` method in `ADPProcessCommunicationService.ts:231-249`
- [ ] Review current `extractParameterValue` method in `ADPProcessCommunicationService.ts:255-349`
- [ ] Identify gaps in existing mathematical patterns for A and B parameters
- [ ] Document current successful extraction patterns to preserve functionality
- [ ] Create test cases for current behavior to prevent regressions

### Task 2: Enhance Mathematical Pattern Matching (AC: 1, 2)

- [ ] Improve A parameter patterns to handle more natural language variations
- [ ] Improve B parameter patterns for comprehensive mathematical operations
- [ ] Add support for additional mathematical operation formats ("5 plus 3", "add 5 to 3")
- [ ] Implement error handling for ambiguous parameter extraction
- [ ] Ensure pattern order prioritizes most specific matches first

### Task 3: Implement Comprehensive Parameter Validation (AC: 1, 3)

- [ ] Add parameter validation for extracted values before handler execution
- [ ] Implement fallback patterns when primary extraction fails
- [ ] Add debug logging for parameter extraction process
- [ ] Create validation methods for different parameter types
- [ ] Ensure proper error messages for failed extractions

### Task 4: Create Comprehensive Unit Tests (AC: 3, 7, 9)

- [ ] Create unit tests for `extractParametersFromRequest` method enhancements
- [ ] Create unit tests for `extractParameterValue` mathematical patterns
- [ ] Add regression tests for existing successful extraction patterns
- [ ] Test edge cases: negative numbers, decimals, complex expressions
- [ ] Add performance tests for pattern matching efficiency

### Task 5: Integration Testing with Real Processes (AC: 4, 5, 6)

- [ ] Test enhanced parameter extraction with deployed calculator processes
- [ ] Verify integration with DocumentationProtocolService.generateMessageTags
- [ ] Test full executeAction workflow with enhanced parameter extraction
- [ ] Validate no breaking changes to existing ADPProcessCommunicationService API
- [ ] Test both ADP-compliant and legacy process parameter handling

### Task 6: Documentation and Maintenance Support (AC: 8)

- [ ] Document new parameter extraction patterns and examples
- [ ] Create developer guide for adding new parameter extraction patterns
- [ ] Add inline documentation for complex regex patterns
- [ ] Update existing method documentation with new capabilities
- [ ] Create troubleshooting guide for parameter extraction issues

## Dev Notes

### Previous Story Insights

**From Story 8.4 Completion Notes:**
- ADP discovery pipeline is now working correctly with deployed processes
- Parameter extraction was enhanced with mathematical patterns for A=15, B=7 extraction
- Calculator processes now successfully respond to Info requests with proper ADP format
- The foundation for parameter extraction is solid but needs enhancement for robustness

**Key Learnings:**
- Natural language processing is critical for user experience with AO processes
- Pattern matching order matters - specific patterns should be evaluated before generic ones
- Comprehensive test coverage is essential for regex-based extraction logic

### Data Models and Interfaces

**ADPProcessCommunicationService.ts Parameter Handling:**
- `extractParametersFromRequest(userRequest: string, handler: HandlerMetadata): Record<string, any>`
- `extractParameterValue(request: string, param: { name: string; type: string }): any`
- `convertParameterValue(value: string, type: string): any`

[Source: src/services/ADPProcessCommunicationService.ts#L231-315]

**Current Parameter Types Supported:**
- `number`: Mathematical values with parseFloat conversion
- `string`: Text values for addresses and identifiers  
- `boolean`: True/false values with lowercase comparison
- `address`: Wallet addresses and process IDs

[Source: src/services/ADPProcessCommunicationService.ts#L215-226]

### API Specifications

**DocumentationProtocolService Integration:**
- `generateMessageTags(handler: HandlerMetadata, parameters: Record<string, any>): Tag[]`
- `validateParameters(handler: HandlerMetadata, parameters: Record<string, any>): ValidationResult`

[Source: src/services/DocumentationProtocolService.ts]

**Tag Generation Format:**
```typescript
interface Tag {
  name: string;
  value: string;
}
```

**Handler Metadata Structure:**
```typescript
interface HandlerMetadata {
  action: string;
  parameters?: Array<{
    name: string;
    type: string;
    required?: boolean;
    description?: string;
  }>;
}
```

[Source: src/services/DocumentationProtocolService.ts]

### File Locations

**Primary Implementation Files:**
- `src/services/ADPProcessCommunicationService.ts` - Main parameter extraction logic
- `src/tools/process/commands/ExecuteActionCommand.ts` - Integration point for executeAction tool

**Test Files:**
- `tests/unit/services/ADPProcessCommunicationService.unit.test.ts` - Unit tests for parameter extraction
- `tests/integration/ExecuteActionADPIntegration.integration.test.ts` - End-to-end testing

[Source: docs/architecture/source-tree.md#L6-22]

### Testing Requirements

**Unit Testing Framework:**
- Use Vitest testing framework as established in project
- Import pattern: `import { describe, it, expect, beforeEach, vi } from "vitest"`
- Mock external dependencies using `vi.mock()`
- File naming: `*.unit.test.ts` suffix

[Source: docs/architecture/tech-stack.md#L13-15]

**Test Coverage Requirements:**
- Functions: 90% coverage target
- Lines: 85% coverage target  
- Branches: 75% coverage target

**Test Scenarios to Cover:**
- Basic mathematical operations: "Add 5 and 3", "Subtract 10 from 20"
- Alternative phrasings: "5 plus 3", "add 5 to 3", "5 + 3"
- Edge cases: negative numbers, decimals, zero values
- Error cases: invalid inputs, missing parameters
- Regression tests: existing successful patterns must continue working

### Technical Constraints

**Existing Pattern Compatibility:**
- Must maintain backward compatibility with current successful extractions
- Cannot break existing ADPProcessCommunicationService API interface
- Pattern matching performance must not significantly degrade

**AO Process Integration:**
- Parameter values must be convertible to appropriate types for AO message tags
- Tag generation must be compatible with DocumentationProtocolService
- Error handling must provide clear user feedback for failed extractions

**TypeScript Requirements:**
- Strict mode compliance with explicit typing
- Proper error handling with meaningful error messages
- ES modules with .js extensions for local imports

[Source: docs/architecture/coding-standards.md#L1-18]

### Current Mathematical Pattern Issues

**Existing A Parameter Patterns (ADPProcessCommunicationService.ts:267-279):**
```typescript
const aPatterns = [
  /add\s+([0-9.]+)\s+(?:and|to|\+)/i, // "add 15 and 7" -> 15
  /([0-9.]+)\s*\+\s*[0-9.]+/i, // "15 + 7" -> 15
  /subtract\s+([0-9.]+)\s+from/i, // "subtract 15 from 20" -> 15 (subtrahend)
  /([0-9.]+)\s*-\s*[0-9.]+/i, // "20 - 15" -> 20
];
```

**Issues with Current Patterns:**
1. Limited natural language variations (doesn't handle "Add 5 plus 3")
2. Order dependency can cause incorrect matches
3. Doesn't handle decimal precision edge cases
4. Limited error handling for ambiguous inputs

**Enhancement Opportunities:**
1. Add more natural language variations ("5 plus 3", "add 5 to 3")
2. Improve pattern specificity to reduce false matches
3. Add validation for extracted parameter values
4. Implement fallback patterns for edge cases

## Project Structure Notes

The file paths align with the established project structure:
- Services located in `src/services/` directory
- Process tools in `src/tools/process/commands/` directory  
- Unit tests in `tests/unit/services/` and `tests/unit/tools/process/`
- Integration tests in `tests/integration/` directory

No structural conflicts identified. Implementation follows existing patterns.

## Definition of Done

- [ ] Parameter extraction logic correctly handles mathematical natural language patterns
- [ ] Natural language requests "Add 5 and 3" generate proper tags A=5, B=3
- [ ] Comprehensive unit tests cover various natural language input formats  
- [ ] Integration tests verify end-to-end calculator process communication
- [ ] Existing successful parameter extractions continue to work unchanged
- [ ] Code follows existing ADPProcessCommunicationService patterns and standards
- [ ] All tests pass (existing and new)
- [ ] Parameter extraction patterns documented for future maintenance
- [ ] Build passes: npm run build && npm run lint && npm run type-check && npm run test

## Risk and Compatibility

**Primary Risk:** Breaking existing working parameter translations during logic improvements

**Mitigation:** Extensive unit testing of existing successful cases, feature flags for new logic

**Rollback:** Maintain original extraction logic as fallback, configuration-based disable of improvements

**Compatibility Verification:**
- [ ] No breaking changes to ADPProcessCommunicationService API
- [ ] ADP protocol compliance maintained  
- [ ] DocumentationProtocolService integration unchanged
- [ ] Performance impact is negligible or improved

## Change Log

| Date       | Version | Description                                              | Author       |
| ---------- | ------- | -------------------------------------------------------- | ------------ |
| 2025-01-18 | 1.0     | Initial story creation with comprehensive technical context | Claude Code  |

